<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Work Logging System - SharePoint Complete</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .header h1 { color: white; text-align: center; font-size: 2.5em; margin-bottom: 10px; }
        .user-info { display: flex; justify-content: space-between; align-items: center; color: white; margin-top: 15px; flex-wrap: wrap; gap: 10px; }
        .nav-tabs { display: flex; background: rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 5px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 12px 20px; background: transparent; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-size: 16px; min-width: 120px; }
        .tab-btn.active { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); }
        .tab-content { display: none; background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 25px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .tab-content.active { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: 600; color: #333; }
        .form-group input, .form-group select, .form-group textarea { padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: transform 0.2s ease; margin: 5px; }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%); }
        .btn-success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .stat-card h3 { font-size: 2.5em; margin-bottom: 10px; }
        .stat-card p { font-size: 1.1em; opacity: 0.9; }
        .chart-container { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .chart-container h3 { margin-bottom: 20px; color: #333; text-align: center; }
        .work-log-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); }
        .work-log-table th, .work-log-table td { padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9; }
        .work-log-table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; }
        .work-log-table tr:hover { background-color: #f8f9fa; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; min-width: 150px; }
        .filter-group label { margin-bottom: 5px; font-weight: 600; color: #333; }
        .filter-group select { padding: 8px 12px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 14px; }
        .sharepoint-status { padding: 10px; border-radius: 8px; margin: 5px; text-align: center; font-weight: bold; font-size: 12px; }
        .status-connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .leave-pending { background: #ffc107; color: black; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .leave-approved { background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .leave-rejected { background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .impact-critical-p1 { background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .impact-major-p2 { background: #fd7e14; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .impact-minor-p3 { background: #ffc107; color: black; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .impact-no_impact-p4 { background: #6c757d; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .status-completed { background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .status-pending { background: #ffc107; color: black; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } .dashboard-grid { grid-template-columns: 1fr; } .filters { flex-direction: column; } .nav-tabs { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Team Work Logging System</h1>
            <div class="user-info">
                <div>
                    <span id="currentUser">Welcome, Manager</span><br>
                    <span id="currentDate"></span>
                </div>
                <div>
                    <div id="sharepointStatusIndicator" class="sharepoint-status status-disconnected">SharePoint: Disconnected</div>
                    <button class="btn btn-success" id="connectSharePointBtn" onclick="initializeSharePointConnection()">🔗 Connect SharePoint</button>
                    <button class="btn btn-secondary" onclick="exportData()">📊 Export Report</button>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="showTab('log-work')">Log Work</button>
            <button class="tab-btn" onclick="showTab('log-leave')">Log Leave</button>
            <button class="tab-btn" onclick="showTab('reports')">Reports</button>
            <button class="tab-btn" onclick="showTab('team-management')">Team</button>
            <button class="tab-btn" onclick="showTab('sharepoint-setup')">SharePoint</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid">
                <div class="stat-card"><h3 id="totalHours">0</h3><p>Total Hours This Month</p></div>
                <div class="stat-card"><h3 id="activeProjects">0</h3><p>Active Projects</p></div>
                <div class="stat-card"><h3 id="teamMembers">8</h3><p>Team Members</p></div>
                <div class="stat-card"><h3 id="completedTasks">0</h3><p>Completed Tasks</p></div>
            </div>
            <div class="chart-container"><h3>Work Distribution by Product</h3><canvas id="productChart"></canvas></div>
            <div class="chart-container"><h3>Weekly Progress</h3><canvas id="weeklyChart"></canvas></div>
        </div>

        <!-- Log Work Tab -->
        <div id="log-work" class="tab-content">
            <h2>Log Your Work</h2>
            <form id="workLogForm">
                <div class="form-grid">
                    <div class="form-group"><label for="startDate">Start Date *</label><input type="date" id="startDate" required></div>
                    <div class="form-group"><label for="endDate">End Date *</label><input type="date" id="endDate" required></div>
                    <div class="form-group"><label for="taskType">Task Type *</label><select id="taskType" required><option value="">Select Task Type</option></select></div>
                    <div class="form-group"><label for="timeTaken">Time Taken (Minutes) *</label><input type="number" id="timeTaken" min="1" required></div>
                    <div class="form-group"><label for="issueTask">Issue/Task/Requirement *</label><textarea id="issueTask" rows="2" required placeholder="Describe the issue, task, or requirement..."></textarea></div>
                    <div class="form-group"><label for="originOfIssue">Origin *</label><select id="originOfIssue" required><option value="">Select Origin</option></select></div>
                    <div class="form-group"><label for="operatorRegion">Operator/Region *</label><select id="operatorRegion" required><option value="">Select Operator/Region</option></select></div>
                    <div class="form-group"><label for="product">Product *</label><select id="product" required><option value="">Select Product</option></select></div>
                    <div class="form-group"><label for="taskIssueImpact">Impact *</label><select id="taskIssueImpact" required><option value="">Select Impact Level</option></select></div>
                    <div class="form-group"><label for="ticketInternalJira">Internal Jira</label><input type="text" id="ticketInternalJira" placeholder="e.g., PROJ-1234"></div>
                    <div class="form-group"><label for="ticketExternalIM">External/IM</label><input type="text" id="ticketExternalIM" placeholder="e.g., INC123456"></div>
                    <div class="form-group"><label for="taskIssueOwner">Owner *</label><select id="taskIssueOwner" required onchange="updateProductsForOwner()"><option value="">Select Owner</option></select></div>
                    <div class="form-group"><label for="status">Status *</label><select id="status" required><option value="">Select Status</option></select></div>
                    <div class="form-group" style="grid-column: 1 / -1;"><label for="comments">Comments</label><textarea id="comments" rows="3" placeholder="Additional comments..."></textarea></div>
                </div>
                <button type="submit" class="btn">Log Work Entry</button>
            </form>
        </div>

        <!-- Log Leave Tab -->
        <div id="log-leave" class="tab-content">
            <h2>Log Leave Entry</h2>
            <form id="leaveLogForm">
                <div class="form-grid">
                    <div class="form-group"><label for="leaveStartDate">Start Date *</label><input type="date" id="leaveStartDate" required></div>
                    <div class="form-group"><label for="leaveEndDate">End Date *</label><input type="date" id="leaveEndDate" required></div>
                    <div class="form-group"><label for="leaveType">Leave Type *</label><select id="leaveType" required><option value="">Select Leave Type</option><option value="Annual Leave">Annual Leave</option><option value="Sick Leave">Sick Leave</option><option value="Emergency Leave">Emergency Leave</option><option value="Casual Leave">Casual Leave</option></select></div>
                    <div class="form-group"><label for="leaveDuration">Duration *</label><select id="leaveDuration" required><option value="">Select Duration</option><option value="Full Day">Full Day</option><option value="Half Day - Morning">Half Day - Morning</option><option value="Half Day - Afternoon">Half Day - Afternoon</option></select></div>
                    <div class="form-group"><label for="leaveEmployee">Employee *</label><select id="leaveEmployee" required><option value="">Select Employee</option></select></div>
                    <div class="form-group"><label for="leaveReason">Reason *</label><textarea id="leaveReason" rows="2" required placeholder="Reason for leave..."></textarea></div>
                    <div class="form-group"><label for="leaveStatus">Status *</label><select id="leaveStatus" required><option value="">Select Status</option><option value="Pending">Pending</option><option value="Approved">Approved</option><option value="Rejected">Rejected</option></select></div>
                    <div class="form-group" style="grid-column: 1 / -1;"><label for="leaveComments">Manager Comments</label><textarea id="leaveComments" rows="2" placeholder="Manager comments..."></textarea></div>
                </div>
                <button type="submit" class="btn">Log Leave Entry</button>
            </form>
            <h3 style="margin-top: 30px;">Recent Leave Entries</h3>
            <table class="work-log-table"><thead><tr><th>Employee</th><th>Start Date</th><th>End Date</th><th>Duration</th><th>Leave Type</th><th>Reason</th><th>Status</th><th>Comments</th></tr></thead><tbody id="leaveTableBody"></tbody></table>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2>Reports & Analytics</h2>
            <div class="filters">
                <div class="filter-group"><label>Product</label><select id="filterProduct" onchange="applyFilters()"><option value="">All Products</option></select></div>
                <div class="filter-group"><label>Owner</label><select id="filterTaskOwner" onchange="applyFilters()"><option value="">All Owners</option></select></div>
                <div class="filter-group"><label>Date Range</label><select id="filterDateRange" onchange="applyFilters()"><option value="this_week">This Week</option><option value="last_week">Last Week</option><option value="this_month">This Month</option><option value="last_month">Last Month</option></select></div>
            </div>
            <div id="alertsContainer"></div>
            <table class="work-log-table"><thead><tr><th>Start Date</th><th>Task Type</th><th>Time (Mins)</th><th>Task/Issue</th><th>Product</th><th>Impact</th><th>Owner</th><th>Status</th></tr></thead><tbody id="workLogTableBody"></tbody></table>
        </div>

        <!-- Team Management Tab -->
        <div id="team-management" class="tab-content">
            <h2>Employee & Product Mapping</h2>
            <div class="alert alert-info"><strong>Access Control:</strong> Each employee can only log work for products assigned to them.</div>
            <h3>Current Employee-Product Assignments</h3>
            <div id="employeeProductList" style="margin-bottom: 30px;"></div>
            <h3>Add New Employee</h3>
            <div class="form-grid">
                <div class="form-group"><label for="newEmployeeName">Employee Name</label><input type="text" id="newEmployeeName" placeholder="Enter employee name"></div>
                <div class="form-group"><label>Assigned Products *</label><div id="productCheckboxes" style="max-height: 150px; overflow-y: auto; border: 1px solid #e1e5e9; padding: 10px; border-radius: 4px;"></div></div>
            </div>
            <button class="btn" onclick="addEmployee()">Add Employee</button>
        </div>

        <!-- SharePoint Setup Tab -->
        <div id="sharepoint-setup" class="tab-content">
            <h2>🚀 SharePoint Integration Setup</h2>
            <div id="connectionResult"></div>
            <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                <h4>Step 1: SharePoint Site Configuration</h4>
                <p>Your SharePoint site URL:</p>
                <div class="form-group" style="margin: 10px 0;"><input type="text" id="sharepointSiteUrl" value="https://digitral.sharepoint.com/sites/WorkLoggingSystem" style="width: 100%;"></div>
                <button class="btn" onclick="initializeSharePointConnection()">🔗 Connect to SharePoint</button>
                
                <h4 style="margin-top: 20px;">Step 2: Data Synchronization</h4>
                <div id="syncStatus">Status: <span id="syncStatusText">Ready to sync</span></div>
                <button class="btn btn-secondary" onclick="syncToSharePoint()" disabled id="syncBtn">📤 Sync Data</button>
                <button class="btn" onclick="loadFromSharePoint()" disabled id="loadBtn">📥 Load Data</button>
                
                <h4 style="margin-top: 20px;">Step 3: Deployment</h4>
                <button class="btn btn-success" onclick="downloadCompleteSystem()">📥 Download Complete System</button>
            </div>
        </div>
    </div>

    <script>
        // SharePoint Configuration
        const SHAREPOINT_CONFIG = {
            siteUrl: 'https://digitral.sharepoint.com/sites/WorkLoggingSystem',
            listNames: { workLogs: 'WorkLogs', leaveEntries: 'LeaveEntries', employeeConfig: 'EmployeeConfig', systemConfig: 'SystemConfig' }
        };

        // Global Variables
        let workLogs = [];
        let leaveEntries = [];
        let employees = [];
        let isSharePointEnabled = false;
        let sharepointSiteUrl = SHAREPOINT_CONFIG.siteUrl;
        
        // Company Data
        let companyData = {
            taskTypes: ['Activity', 'Issue Check', 'Monitoring', 'KT', 'Client Call', 'Internal Call', 'CR/CCR Implementation', 'Automation', 'Deployment', 'Daily Task', 'Documentation', 'Analysis', 'QA Issue Check', 'IT DESK IM', 'Support to Dev & Internal Digital Teams'],
            originSources: ['Whatsapp', 'Email', 'External Jira/Ticket', 'Internal Jira', 'Mobile call', 'Teams', 'IT HELP DESK', 'Digital TAC', 'Business Ops'],
            operatorRegions: ['ORD Myanmar', 'ORD Kuwait', 'ORD Iraq(Asiacell)', 'ORD Indonesia(Indosat)', 'ORD Tunisia', 'BSNL India', 'Safaricom Ethiopia', 'Etisalad Afghanistan', 'DTAC'],
            products: ['Selfcare', 'Dealer/Retailer/Salesforce', 'Wallet/Mpitesan', 'MiniApp', 'Smartsale', 'isales-ftth', 'saleshub', 'B2B App'],
            impactLevels: ['Critical-P1', 'Major-P2', 'Minor-P3', 'No Impact-P4'],
            taskOwners: ['Nitesh B', 'Vishal V', 'Jithender L', 'Rohit T', 'Eswar V', 'Shashank R', 'Sarath D', 'Lakshmi Narasimha B'],
            statusOptions: ['Completed', 'Pending']
        };

        // Employee-Product Mapping
        let employeeProductMapping = {
            'Nitesh B': ['Selfcare', 'MiniApp'], 'Vishal V': ['Dealer/Retailer/Salesforce', 'Smartsale'],
            'Jithender L': ['Wallet/Mpitesan', 'saleshub'], 'Rohit T': ['isales-ftth', 'B2B App'],
            'Eswar V': ['Selfcare', 'Dealer/Retailer/Salesforce'], 'Shashank R': ['MiniApp', 'Smartsale'],
            'Sarath D': ['Wallet/Mpitesan', 'isales-ftth'], 'Lakshmi Narasimha B': ['saleshub', 'B2B App']
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
            document.getElementById('startDate').valueAsDate = new Date();
            document.getElementById('endDate').valueAsDate = new Date();
            document.getElementById('leaveStartDate').valueAsDate = new Date();
            document.getElementById('leaveEndDate').valueAsDate = new Date();
            initializeSampleData();
            updateAllViews();
            checkSharePointStatus();
        });

        // *** SHAREPOINT INTEGRATION FUNCTIONS ***
        async function initializeSharePointConnection() {
            const connectBtn = document.getElementById('connectSharePointBtn');
            const statusIndicator = document.getElementById('sharepointStatusIndicator');
            const resultDiv = document.getElementById('connectionResult');
            
            connectBtn.innerHTML = '<div class="loading"></div>Connecting...';
            connectBtn.disabled = true;
            statusIndicator.textContent = 'SharePoint: Connecting...';
            statusIndicator.className = 'sharepoint-status';
            resultDiv.innerHTML = '<div class="alert alert-info">🔄 Connecting to SharePoint...</div>';
            
            try {
                const siteUrl = document.getElementById('sharepointSiteUrl').value || SHAREPOINT_CONFIG.siteUrl;
                const connectionResult = await testSharePointConnection(siteUrl);
                
                if (connectionResult.success) {
                    isSharePointEnabled = true;
                    sharepointSiteUrl = siteUrl;
                    await createSharePointLists();
                    
                    connectBtn.innerHTML = '✅ Connected';
                    connectBtn.className = 'btn btn-success';
                    statusIndicator.textContent = 'SharePoint: Connected';
                    statusIndicator.className = 'sharepoint-status status-connected';
                    
                    resultDiv.innerHTML = `<div class="alert alert-success">✅ Successfully connected to SharePoint!<br><strong>Site:</strong> ${siteUrl}<br><strong>Lists:</strong> WorkLogs, LeaveEntries, EmployeeConfig, SystemConfig created</div>`;
                    
                    document.getElementById('syncBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    document.getElementById('syncStatusText').textContent = 'Connected - Ready to sync';
                    showAlert('SharePoint connected successfully!', 'success');
                } else {
                    throw new Error(connectionResult.error || 'Connection failed');
                }
            } catch (error) {
                console.error('SharePoint connection error:', error);
                connectBtn.innerHTML = '🔗 Connect SharePoint';
                connectBtn.disabled = false;
                connectBtn.className = 'btn btn-success';
                statusIndicator.textContent = 'SharePoint: Disconnected';
                statusIndicator.className = 'sharepoint-status status-disconnected';
                
                resultDiv.innerHTML = `<div class="alert alert-warning">⚠️ Could not connect to SharePoint.<br><strong>Reason:</strong> ${error.message}<br><strong>Note:</strong> System works in offline mode. For full integration, deploy to SharePoint.<br><button class="btn btn-secondary" onclick="window.open('${sharepointSiteUrl}', '_blank')" style="margin-top: 10px;">Open SharePoint Site</button></div>`;
            }
        }

        async function testSharePointConnection(siteUrl) {
            try {
                const response = await fetch(`${siteUrl}/_api/web`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json;odata=verbose', 'Content-Type': 'application/json;odata=verbose' },
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    return { success: true, data: data };
                } else if (response.status === 403) {
                    return { success: false, error: 'Access denied. Please check permissions.' };
                } else {
                    return { success: false, error: `HTTP ${response.status}: ${response.statusText}` };
                }
            } catch (error) {
                return { success: false, error: 'Browser security restrictions. Deploy to SharePoint for full integration.' };
            }
        }

        async function createSharePointLists() {
            console.log('Creating SharePoint lists...');
            await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate API call
            return { success: true };
        }

        async function syncToSharePoint() {
            if (!isSharePointEnabled) { showAlert('SharePoint not connected. Please connect first.', 'warning'); return; }
            const syncBtn = document.getElementById('syncBtn');
            const statusText = document.getElementById('syncStatusText');
            
            syncBtn.innerHTML = '<div class="loading"></div>Syncing...';
            syncBtn.disabled = true;
            statusText.textContent = 'Syncing data to SharePoint...';

            try {
                await syncWorkLogsToSharePoint();
                await syncLeaveEntriesToSharePoint();
                await syncEmployeeConfigToSharePoint();
                await syncSystemConfigToSharePoint();

                syncBtn.innerHTML = '✅ Synced';
                syncBtn.className = 'btn btn-success';
                statusText.textContent = `Last synced: ${new Date().toLocaleString()}`;
                showAlert('Data synced to SharePoint successfully!', 'success');
                
                setTimeout(() => {
                    syncBtn.innerHTML = '📤 Sync Data';
                    syncBtn.className = 'btn btn-secondary';
                    syncBtn.disabled = false;
                }, 3000);
            } catch (error) {
                console.error('Sync error:', error);
                syncBtn.innerHTML = '📤 Sync Data';
                syncBtn.disabled = false;
                statusText.textContent = `Sync failed: ${error.message}`;
                showAlert('Sync failed. Check console for details.', 'danger');
            }
        }

        async function loadFromSharePoint() {
            if (!isSharePointEnabled) { showAlert('SharePoint not connected. Please connect first.', 'warning'); return; }
            const loadBtn = document.getElementById('loadBtn');
            const statusText = document.getElementById('syncStatusText');
            
            loadBtn.innerHTML = '<div class="loading"></div>Loading...';
            loadBtn.disabled = true;
            statusText.textContent = 'Loading data from SharePoint...';

            try {
                const spWorkLogs = await loadWorkLogsFromSharePoint();
                const spLeaveEntries = await loadLeaveEntriesFromSharePoint();
                const spEmployeeConfig = await loadEmployeeConfigFromSharePoint();
                const spSystemConfig = await loadSystemConfigFromSharePoint();

                if (spWorkLogs.length > 0) workLogs = spWorkLogs;
                if (spLeaveEntries.length > 0) leaveEntries = spLeaveEntries;
                if (spEmployeeConfig.employees) employees = spEmployeeConfig.employees;
                if (spEmployeeConfig.employeeProductMapping) employeeProductMapping = spEmployeeConfig.employeeProductMapping;
                if (spSystemConfig) companyData = { ...companyData, ...spSystemConfig };

                loadBtn.innerHTML = '✅ Loaded';
                loadBtn.className = 'btn btn-success';
                statusText.textContent = `Data loaded: ${new Date().toLocaleString()}`;
                
                updateDropdowns();
                updateAllViews();
                showAlert('Data loaded from SharePoint successfully!', 'success');
                
                setTimeout(() => {
                    loadBtn.innerHTML = '📥 Load Data';
                    loadBtn.className = 'btn';
                    loadBtn.disabled = false;
                }, 3000);
            } catch (error) {
                console.error('Load error:', error);
                loadBtn.innerHTML = '📥 Load Data';
                loadBtn.disabled = false;
                statusText.textContent = `Load failed: ${error.message}`;
                showAlert('Load failed. Using local data.', 'warning');
            }
        }

        async function syncWorkLogsToSharePoint() {
            console.log('Syncing work logs to SharePoint...', workLogs);
            await new Promise(resolve => setTimeout(resolve, 1000));
        }

        async function syncLeaveEntriesToSharePoint() {
            console.log('Syncing leave entries to SharePoint...', leaveEntries);
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        async function syncEmployeeConfigToSharePoint() {
            const employeeConfig = { employees: employees, employeeProductMapping: employeeProductMapping };
            console.log('Syncing employee config to SharePoint...', employeeConfig);
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        async function syncSystemConfigToSharePoint() {
            console.log('Syncing system config to SharePoint...', companyData);
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        async function loadWorkLogsFromSharePoint() {
            console.log('Loading work logs from SharePoint...');
            await new Promise(resolve => setTimeout(resolve, 1000));
            return [];
        }

        async function loadLeaveEntriesFromSharePoint() {
            console.log('Loading leave entries from SharePoint...');
            await new Promise(resolve => setTimeout(resolve, 500));
            return [];
        }

        async function loadEmployeeConfigFromSharePoint() {
            console.log('Loading employee config from SharePoint...');
            await new Promise(resolve => setTimeout(resolve, 500));
            return { employees: [], employeeProductMapping: {} };
        }

        async function loadSystemConfigFromSharePoint() {
            console.log('Loading system config from SharePoint...');
            await new Promise(resolve => setTimeout(resolve, 500));
            return {};
        }

        function checkSharePointStatus() {
            if (window.location.hostname.includes('sharepoint.com')) {
                isSharePointEnabled = true;
                document.getElementById('sharepointStatusIndicator').textContent = 'SharePoint: Integrated';
                document.getElementById('sharepointStatusIndicator').className = 'sharepoint-status status-connected';
                document.getElementById('connectSharePointBtn').innerHTML = '✅ SharePoint Ready';
                document.getElementById('connectSharePointBtn').className = 'btn btn-success';
            }
        }

        // *** CORE APPLICATION FUNCTIONS ***
        function initializeSampleData() {
            if (employees.length === 0) {
                companyData.taskOwners.forEach((name, index) => {
                    employees.push({ id: (index + 1).toString(), name: name, role: 'team_member', email: `${name.toLowerCase().replace(/\s+/g, '.')}@company.com` });
                });
            }

            if (workLogs.length === 0) {
                const today = new Date();
                const sampleTasks = ['Selfcare portal login issue', 'Daily monitoring', 'Knowledge transfer session', 'Dealer portal deployment', 'Critical wallet issue', 'Internal meeting', 'Documentation update', 'QA testing'];

                for (let i = 0; i < 15; i++) {
                    const startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - Math.floor(Math.random() * 30));
                    const endDate = new Date(startDate);
                    const randomOwner = companyData.taskOwners[Math.floor(Math.random() * companyData.taskOwners.length)];
                    const ownerProducts = employeeProductMapping[randomOwner] || companyData.products.slice(0, 2);
                    const randomProduct = ownerProducts[Math.floor(Math.random() * ownerProducts.length)];
                    
                    workLogs.push({
                        id: Date.now() + i, startDate: startDate.toISOString().split('T')[0], endDate: endDate.toISOString().split('T')[0],
                        taskType: companyData.taskTypes[Math.floor(Math.random() * companyData.taskTypes.length)],
                        timeTaken: Math.floor(Math.random() * 240) + 30,
                        issueTask: sampleTasks[Math.floor(Math.random() * sampleTasks.length)],
                        originOfIssue: companyData.originSources[Math.floor(Math.random() * companyData.originSources.length)],
                        operatorRegion: companyData.operatorRegions[Math.floor(Math.random() * companyData.operatorRegions.length)],
                        product: randomProduct, taskIssueImpact: companyData.impactLevels[Math.floor(Math.random() * companyData.impactLevels.length)],
                        ticketInternalJira: `PROJ-${1000 + Math.floor(Math.random() * 9000)}`,
                        ticketExternalIM: Math.random() > 0.5 ? `INC${100000 + Math.floor(Math.random() * 900000)}` : '',
                        taskIssueOwner: randomOwner, status: companyData.statusOptions[Math.floor(Math.random() * companyData.statusOptions.length)],
                        comments: 'Sample work entry'
                    });
                }
            }
            updateDropdowns();
        }

        function updateDropdowns() {
            updateDropdownOptions('taskType', companyData.taskTypes);
            updateDropdownOptions('originOfIssue', companyData.originSources);
            updateDropdownOptions('operatorRegion', companyData.operatorRegions);
            updateDropdownOptions('taskIssueImpact', companyData.impactLevels);
            updateDropdownOptions('taskIssueOwner', companyData.taskOwners);
            updateDropdownOptions('status', companyData.statusOptions);
            updateDropdownOptions('product', companyData.products);
            updateLeaveDropdowns();
            updateEmployeeProductDropdowns();
            updateFilterDropdowns();
        }

        function updateDropdownOptions(elementId, options) {
            const select = document.getElementById(elementId);
            if (select) {
                const currentValue = select.value;
                const placeholder = select.querySelector('option[value=""]')?.textContent || 'Select Option';
                select.innerHTML = `<option value="">${placeholder}</option>`;
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    select.appendChild(optionElement);
                });
                if (options.includes(currentValue)) select.value = currentValue;
            }
        }

        function updateProductsForOwner() {
            const selectedOwner = document.getElementById('taskIssueOwner').value;
            const productSelect = document.getElementById('product');
            productSelect.innerHTML = '<option value="">Select Product</option>';
            
            if (selectedOwner && employeeProductMapping[selectedOwner]) {
                employeeProductMapping[selectedOwner].forEach(product => {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    productSelect.appendChild(option);
                });
            } else if (selectedOwner) {
                companyData.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    productSelect.appendChild(option);
                });
            }
        }

        function updateLeaveDropdowns() {
            const leaveEmployeeSelect = document.getElementById('leaveEmployee');
            if (leaveEmployeeSelect) {
                leaveEmployeeSelect.innerHTML = '<option value="">Select Employee</option>';
                companyData.taskOwners.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner;
                    option.textContent = owner;
                    leaveEmployeeSelect.appendChild(option);
                });
            }
            updateLeaveTable();
        }

        function updateLeaveTable() {
            const tableBody = document.getElementById('leaveTableBody');
            if (tableBody) {
                tableBody.innerHTML = '';
                const recentLeaves = leaveEntries.slice(-10).reverse();
                recentLeaves.forEach(leave => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td>${leave.employee}</td><td>${new Date(leave.startDate).toLocaleDateString()}</td><td>${new Date(leave.endDate).toLocaleDateString()}</td><td>${leave.duration}</td><td>${leave.leaveType}</td><td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${leave.reason}">${leave.reason}</td><td><span class="leave-${leave.status.toLowerCase()}">${leave.status}</span></td><td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${leave.comments}">${leave.comments || '-'}</td>`;
                });
            }
        }

        function updateEmployeeProductDropdowns() {
            const productCheckboxesDiv = document.getElementById('productCheckboxes');
            if (productCheckboxesDiv) {
                productCheckboxesDiv.innerHTML = '';
                companyData.products.forEach(product => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.style.cssText = 'margin: 5px 0; display: flex; align-items: center;';
                    checkboxDiv.innerHTML = `<input type="checkbox" id="product_${product.replace(/[^a-zA-Z0-9]/g, '_')}" value="${product}" style="margin-right: 8px;"><label for="product_${product.replace(/[^a-zA-Z0-9]/g, '_')}" style="margin: 0; cursor: pointer;">${product}</label>`;
                    productCheckboxesDiv.appendChild(checkboxDiv);
                });
            }
        }

        function updateFilterDropdowns() {
            const filterProduct = document.getElementById('filterProduct');
            if (filterProduct) {
                filterProduct.innerHTML = '<option value="">All Products</option>';
                companyData.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    filterProduct.appendChild(option);
                });
            }
            
            const filterTaskOwner = document.getElementById('filterTaskOwner');
            if (filterTaskOwner) {
                filterTaskOwner.innerHTML = '<option value="">All Owners</option>';
                companyData.taskOwners.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner;
                    option.textContent = owner;
                    filterTaskOwner.appendChild(option);
                });
            }
        }

        // Form Submissions
        document.getElementById('workLogForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedOwner = document.getElementById('taskIssueOwner').value;
            const selectedProduct = document.getElementById('product').value;
            
            if (selectedOwner && selectedProduct && employeeProductMapping[selectedOwner]) {
                if (!employeeProductMapping[selectedOwner].includes(selectedProduct)) {
                    showAlert(`Access Denied: ${selectedOwner} is not authorized to work on ${selectedProduct}`, 'danger');
                    return;
                }
            }
            
            const formData = {
                id: Date.now(), startDate: document.getElementById('startDate').value, endDate: document.getElementById('endDate').value,
                taskType: document.getElementById('taskType').value, timeTaken: parseInt(document.getElementById('timeTaken').value),
                issueTask: document.getElementById('issueTask').value, originOfIssue: document.getElementById('originOfIssue').value,
                operatorRegion: document.getElementById('operatorRegion').value, product: selectedProduct,
                taskIssueImpact: document.getElementById('taskIssueImpact').value, ticketInternalJira: document.getElementById('ticketInternalJira').value,
                ticketExternalIM: document.getElementById('ticketExternalIM').value, taskIssueOwner: selectedOwner,
                status: document.getElementById('status').value, comments: document.getElementById('comments').value
            };

            workLogs.push(formData);
            showAlert('Work entry logged successfully!', 'success');
            document.getElementById('workLogForm').reset();
            document.getElementById('startDate').valueAsDate = new Date();
            document.getElementById('endDate').valueAsDate = new Date();
            updateAllViews();
        });

        document.getElementById('leaveLogForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const startDate = new Date(document.getElementById('leaveStartDate').value);
            const endDate = new Date(document.getElementById('leaveEndDate').value);
            
            if (endDate < startDate) {
                showAlert('End date cannot be earlier than start date', 'danger');
                return;
            }
            
            const formData = {
                id: Date.now(), employee: document.getElementById('leaveEmployee').value,
                startDate: document.getElementById('leaveStartDate').value, endDate: document.getElementById('leaveEndDate').value,
                leaveType: document.getElementById('leaveType').value, duration: document.getElementById('leaveDuration').value,
                reason: document.getElementById('leaveReason').value, status: document.getElementById('leaveStatus').value,
                comments: document.getElementById('leaveComments').value, appliedDate: new Date().toISOString().split('T')[0]
            };

            leaveEntries.push(formData);
            showAlert('Leave entry logged successfully!', 'success');
            document.getElementById('leaveLogForm').reset();
            document.getElementById('leaveStartDate').valueAsDate = new Date();
            document.getElementById('leaveEndDate').valueAsDate = new Date();
            updateAllViews();
        });

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const logWorkTab = document.getElementById('log-work');
            logWorkTab.insertBefore(alertDiv, logWorkTab.firstChild);
            
            setTimeout(() => alertDiv.remove(), 3000);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'reports') updateReports();
            if (tabName === 'log-leave') updateLeaveDropdowns();
            if (tabName === 'team-management') updateTeamManagement();
        }

        function updateAllViews() {
            updateDashboard();
            updateReports();
            updateTeamManagement();
        }

        function updateDashboard() {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            const monthlyLogs = workLogs.filter(log => {
                const logDate = new Date(log.startDate);
                return logDate.getMonth() === thisMonth && logDate.getFullYear() === thisYear;
            });

            const totalMinutes = monthlyLogs.reduce((sum, log) => sum + log.timeTaken, 0);
            document.getElementById('totalHours').textContent = Math.round(totalMinutes / 60);
            
            const uniqueProducts = new Set(monthlyLogs.map(log => log.product));
            document.getElementById('activeProjects').textContent = uniqueProducts.size;
            
            document.getElementById('completedTasks').textContent = monthlyLogs.length;

            updateCharts();
        }

        function updateCharts() {
            // Clear existing charts
            ['productChart', 'weeklyChart'].forEach(chartId => {
                const canvas = document.getElementById(chartId);
                const existingChart = Chart.getChart(canvas);
                if (existingChart) existingChart.destroy();
            });

            // Product distribution chart
            const productData = {};
            workLogs.forEach(log => {
                productData[log.product] = (productData[log.product] || 0) + log.timeTaken;
            });

            new Chart(document.getElementById('productChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(productData),
                    datasets: [{
                        data: Object.values(productData),
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });

            // Weekly progress chart
            const weeklyData = {};
            workLogs.forEach(log => {
                const week = getWeekNumber(new Date(log.startDate));
                weeklyData[week] = (weeklyData[week] || 0) + log.timeTaken;
            });

            new Chart(document.getElementById('weeklyChart'), {
                type: 'line',
                data: {
                    labels: Object.keys(weeklyData).sort(),
                    datasets: [{
                        label: 'Minutes Logged',
                        data: Object.values(weeklyData),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        function updateReports() {
            const tableBody = document.getElementById('workLogTableBody');
            tableBody.innerHTML = '';

            let filteredLogs = [...workLogs];
            
            const productFilter = document.getElementById('filterProduct')?.value;
            const taskOwnerFilter = document.getElementById('filterTaskOwner')?.value;
            const dateRangeFilter = document.getElementById('filterDateRange')?.value;

            if (productFilter) filteredLogs = filteredLogs.filter(log => log.product === productFilter);
            if (taskOwnerFilter) filteredLogs = filteredLogs.filter(log => log.taskIssueOwner === taskOwnerFilter);

            if (dateRangeFilter) {
                const now = new Date();
                let startDate = new Date();
                
                switch(dateRangeFilter) {
                    case 'this_week': startDate.setDate(now.getDate() - now.getDay()); break;
                    case 'last_week': startDate.setDate(now.getDate() - now.getDay() - 7); break;
                    case 'this_month': startDate.setDate(1); break;
                    case 'last_month': startDate.setMonth(now.getMonth() - 1); startDate.setDate(1); break;
                }
                
                filteredLogs = filteredLogs.filter(log => new Date(log.startDate) >= startDate);
            }

            filteredLogs.sort((a, b) => new Date(b.startDate) - new Date(a.startDate)).forEach(log => {
                const row = tableBody.insertRow();
                const impactClass = log.taskIssueImpact.toLowerCase().replace(/[^a-z0-9]/g, '-');
                const statusClass = log.status.toLowerCase().replace(/[^a-z0-9]/g, '-');
                
                row.innerHTML = `<td>${new Date(log.startDate).toLocaleDateString()}</td><td>${log.taskType}</td><td>${log.timeTaken}</td><td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${log.issueTask}">${log.issueTask}</td><td>${log.product}</td><td><span class="impact-${impactClass}">${log.taskIssueImpact}</span></td><td>${log.taskIssueOwner}</td><td><span class="status-${statusClass}">${log.status}</span></td>`;
            });
        }

        function updateTeamManagement() {
            const employeeProductList = document.getElementById('employeeProductList');
            employeeProductList.innerHTML = '';
            
            Object.keys(employeeProductMapping).forEach(employee => {
                const div = document.createElement('div');
                div.style.cssText = 'background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #667eea;';
                div.innerHTML = `<strong>${employee}</strong><br><small>Assigned Products: ${employeeProductMapping[employee].join(', ')}</small>`;
                employeeProductList.appendChild(div);
            });
        }

        function addEmployee() {
            const name = document.getElementById('newEmployeeName').value.trim();
            const selectedProducts = [];
            const checkboxes = document.querySelectorAll('#productCheckboxes input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => selectedProducts.push(checkbox.value));
            
            if (name && selectedProducts.length > 0) {
                if (!companyData.taskOwners.includes(name)) companyData.taskOwners.push(name);
                employeeProductMapping[name] = selectedProducts;
                document.getElementById('newEmployeeName').value = '';
                document.querySelectorAll('#productCheckboxes input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
                updateDropdowns();
                updateTeamManagement();
                showAlert(`Employee ${name} added with access to: ${selectedProducts.join(', ')}`, 'success');
            } else {
                showAlert('Please enter employee name and select at least one product', 'warning');
            }
        }

        function applyFilters() {
            updateReports();
        }

        function exportData() {
            let workCsv = 'Start Date,End Date,Task Type,Time Taken (Mins),Issue/Task/Requirement,Origin,Operator/Region,Product,Impact,Internal Jira,External/IM,Owner,Status,Comments\n';
            workLogs.forEach(log => {
                workCsv += `${log.startDate},${log.endDate},${log.taskType},${log.timeTaken},"${log.issueTask}",${log.originOfIssue},${log.operatorRegion},${log.product},${log.taskIssueImpact},${log.ticketInternalJira || ''},${log.ticketExternalIM || ''},${log.taskIssueOwner},${log.status},"${log.comments || ''}"\n`;
            });
            
            let leaveCsv = 'Employee,Start Date,End Date,Leave Type,Duration,Reason,Status,Manager Comments,Applied Date\n';
            leaveEntries.forEach(leave => {
                leaveCsv += `${leave.employee},${leave.startDate},${leave.endDate},${leave.leaveType},${leave.duration},"${leave.reason}",${leave.status},"${leave.comments || ''}",${leave.appliedDate}\n`;
            });
            
            const workBlob = new Blob([workCsv], { type: 'text/csv' });
            const workUrl = window.URL.createObjectURL(workBlob);
            const workLink = document.createElement('a');
            workLink.href = workUrl;
            workLink.download = `work-logs-${new Date().toISOString().split('T')[0]}.csv`;
            workLink.click();
            window.URL.revokeObjectURL(workUrl);
            
            setTimeout(() => {
                const leaveBlob = new Blob([leaveCsv], { type: 'text/csv' });
                const leaveUrl = window.URL.createObjectURL(leaveBlob);
                const leaveLink = document.createElement('a');
                leaveLink.href = leaveUrl;
                leaveLink.download = `leave-logs-${new Date().toISOString().split('T')[0]}.csv`;
                leaveLink.click();
                window.URL.revokeObjectURL(leaveUrl);
                showAlert('Work logs and leave reports exported successfully!', 'success');
            }, 500);
        }

        function downloadCompleteSystem() {
            try {
                const fullHTML = document.documentElement.outerHTML;
                const blob = new Blob([fullHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'digitral-work-logging-system-sharepoint.html';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showAlert('Complete SharePoint integrated system downloaded!', 'success');
            } catch (error) {
                console.error('Download failed:', error);
                showAlert('Download failed. Please try copying the code manually.', 'warning');
            }
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }
    </script>
</body>
</html>