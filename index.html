<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Work Logging System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: white;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-top: 15px;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .work-log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .work-log-table th, .work-log-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        .work-log-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .work-log-table tr:hover {
            background-color: #f8f9fa;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
        }

        .week-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .week-btn {
            padding: 8px 16px;
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .week-btn.active {
            background: #667eea;
            color: white;
        }

        .setup-guide {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .setup-step {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }

        .setup-step h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }

        .report-content {
            display: none;
        }

        .report-content.active {
            display: block;
        }

        .leave-pending { background: #ffc107; color: black; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .leave-approved { background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .leave-rejected { background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }

        .impact-critical-p1 { background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .impact-major-p2 { background: #fd7e14; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .impact-minor-p3 { background: #ffc107; color: black; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .impact-no_impact-p4 { background: #6c757d; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }

        .status-completed { background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .status-pending { background: #ffc107; color: black; padding: 2px 6px; border-radius: 4px; font-size: 12px; }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Team Work Logging System</h1>
            <div class="user-info">
                <div>
                    <span id="currentUser">Welcome, Manager</span>
                    <span id="currentDate"></span>
                </div>
                <div>
                    <button class="btn btn-success" id="sharepointSetupBtn" onclick="showSharePointSetup()">üîó Setup SharePoint</button>
                    <button class="btn btn-secondary" onclick="exportData()">üìä Export Report</button>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="showTab('log-work')">Log Work</button>
            <button class="tab-btn" onclick="showTab('log-leave')">Log Leave</button>
            <button class="tab-btn" onclick="showTab('reports')">Reports</button>
            <button class="tab-btn" onclick="showTab('team-management')">Team Management</button>
            <button class="tab-btn" onclick="showTab('list-management')">List Management</button>
            <button class="tab-btn" onclick="showTab('monthly-view')">Monthly View</button>
            <button class="tab-btn" onclick="showTab('sharepoint-setup')">SharePoint Setup</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3 id="totalHours">0</h3>
                    <p>Total Hours This Month</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeProjects">0</h3>
                    <p>Active Projects</p>
                </div>
                <div class="stat-card">
                    <h3 id="teamMembers">0</h3>
                    <p>Team Members</p>
                </div>
                <div class="stat-card">
                    <h3 id="completedTasks">0</h3>
                    <p>Completed Tasks</p>
                </div>
            </div>

            <div class="chart-container">
                <h3>Work Distribution by Country</h3>
                <canvas id="countryChart"></canvas>
            </div>

            <div class="chart-container">
                <h3>Weekly Progress</h3>
                <canvas id="weeklyChart"></canvas>
            </div>

            <div class="chart-container">
                <h3>Task Distribution</h3>
                <canvas id="taskChart"></canvas>
            </div>
        </div>

        <!-- Log Work Tab -->
        <div id="log-work" class="tab-content">
            <h2>Log Your Work</h2>
            <form id="workLogForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="startDate">Start Date *</label>
                        <input type="date" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date *</label>
                        <input type="date" id="endDate" required>
                    </div>
                    <div class="form-group">
                        <label for="taskType">Task Type *</label>
                        <select id="taskType" required>
                            <option value="">Select Task Type</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="timeTaken">Time Taken (Minutes) *</label>
                        <input type="number" id="timeTaken" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="issueTask">Issue/Task/Requirement *</label>
                        <textarea id="issueTask" rows="2" required placeholder="Describe the issue, task, or requirement..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="originOfIssue">Origin of the Issue/Task/Requirement *</label>
                        <select id="originOfIssue" required>
                            <option value="">Select Origin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="operatorRegion">Operator/Region *</label>
                        <select id="operatorRegion" required>
                            <option value="">Select Operator/Region</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="product">Product *</label>
                        <select id="product" required>
                            <option value="">Select Product</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskIssueImpact">Task/Issue Impact *</label>
                        <select id="taskIssueImpact" required>
                            <option value="">Select Impact Level</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ticketInternalJira">Ticket Internal Jira</label>
                        <input type="text" id="ticketInternalJira" placeholder="e.g., PROJ-1234">
                    </div>
                    <div class="form-group">
                        <label for="ticketExternalIM">Ticket External/IM</label>
                        <input type="text" id="ticketExternalIM" placeholder="e.g., INC123456, CHG789">
                    </div>
                    <div class="form-group">
                        <label for="taskIssueOwner">Task/Issue Owner *</label>
                        <select id="taskIssueOwner" required onchange="updateProductsForOwner()">
                            <option value="">Select Owner</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">Status *</label>
                        <select id="status" required>
                            <option value="">Select Status</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="comments">Comments</label>
                        <textarea id="comments" rows="3" placeholder="Additional comments or notes..."></textarea>
                    </div>
                </div>
                <button type="submit" class="btn">Log Work Entry</button>
            </form>
        </div>

        <!-- Log Leave Tab -->
        <div id="log-leave" class="tab-content">
            <h2>Log Leave Entry</h2>
            <form id="leaveLogForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="leaveStartDate">Leave Start Date *</label>
                        <input type="date" id="leaveStartDate" required>
                    </div>
                    <div class="form-group">
                        <label for="leaveEndDate">Leave End Date *</label>
                        <input type="date" id="leaveEndDate" required>
                    </div>
                    <div class="form-group">
                        <label for="leaveType">Leave Type *</label>
                        <select id="leaveType" required>
                            <option value="">Select Leave Type</option>
                            <option value="Annual Leave">Annual Leave</option>
                            <option value="Sick Leave">Sick Leave</option>
                            <option value="Emergency Leave">Emergency Leave</option>
                            <option value="Maternity Leave">Maternity Leave</option>
                            <option value="Paternity Leave">Paternity Leave</option>
                            <option value="Casual Leave">Casual Leave</option>
                            <option value="Compensatory Off">Compensatory Off</option>
                            <option value="Work From Home">Work From Home</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="leaveDuration">Leave Duration *</label>
                        <select id="leaveDuration" required>
                            <option value="">Select Duration</option>
                            <option value="Full Day">Full Day</option>
                            <option value="Half Day - Morning">Half Day - Morning</option>
                            <option value="Half Day - Afternoon">Half Day - Afternoon</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="leaveEmployee">Employee *</label>
                        <select id="leaveEmployee" required>
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="leaveReason">Reason *</label>
                        <textarea id="leaveReason" rows="2" required placeholder="Reason for leave..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="leaveStatus">Status *</label>
                        <select id="leaveStatus" required>
                            <option value="">Select Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="leaveComments">Manager Comments</label>
                        <textarea id="leaveComments" rows="2" placeholder="Manager comments or notes..."></textarea>
                    </div>
                </div>
                <button type="submit" class="btn">Log Leave Entry</button>
            </form>

            <h3 style="margin-top: 30px;">Recent Leave Entries</h3>
            <table class="work-log-table">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Duration</th>
                        <th>Leave Type</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody id="leaveTableBody">
                </tbody>
            </table>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2>Reports & Analytics</h2>
            
            <div class="nav-tabs" style="margin-bottom: 20px;">
                <button class="tab-btn active" onclick="showReportTab('work-reports')">Work Reports</button>
                <button class="tab-btn" onclick="showReportTab('leave-reports')">Leave Reports</button>
            </div>

            <!-- Work Reports -->
            <div id="work-reports" class="report-content active">
                <div class="filters">
                    <div class="filter-group">
                        <label>Product</label>
                        <select id="filterProduct" onchange="applyFilters()">
                            <option value="">All Products</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Task Owner</label>
                        <select id="filterTaskOwner" onchange="applyFilters()">
                            <option value="">All Owners</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date Range</label>
                        <select id="filterDateRange" onchange="applyFilters()">
                            <option value="this_week">This Week</option>
                            <option value="last_week">Last Week</option>
                            <option value="this_month">This Month</option>
                            <option value="last_month">Last Month</option>
                        </select>
                    </div>
                </div>

                <div id="alertsContainer"></div>

                <table class="work-log-table">
                    <thead>
                        <tr>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Task Type</th>
                            <th>Time (Mins)</th>
                            <th>Issue/Task/Requirement</th>
                            <th>Origin</th>
                            <th>Operator/Region</th>
                            <th>Product</th>
                            <th>Impact</th>
                            <th>Internal Jira</th>
                            <th>External/IM</th>
                            <th>Owner</th>
                            <th>Status</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody id="workLogTableBody">
                    </tbody>
                </table>
            </div>

            <!-- Leave Reports -->
            <div id="leave-reports" class="report-content">
                <div class="filters">
                    <div class="filter-group">
                        <label>Employee</label>
                        <select id="filterLeaveEmployee" onchange="applyLeaveFilters()">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Leave Type</label>
                        <select id="filterLeaveType" onchange="applyLeaveFilters()">
                            <option value="">All Types</option>
                            <option value="Annual Leave">Annual Leave</option>
                            <option value="Sick Leave">Sick Leave</option>
                            <option value="Emergency Leave">Emergency Leave</option>
                            <option value="Casual Leave">Casual Leave</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filterLeaveStatus" onchange="applyLeaveFilters()">
                            <option value="">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                </div>

                <div class="dashboard-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <h3 id="totalLeaveDays">0</h3>
                        <p>Total Leave Days This Month</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="pendingLeaves">0</h3>
                        <p>Pending Leave Requests</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="approvedLeaves">0</h3>
                        <p>Approved Leaves</p>
                    </div>
                </div>

                <table class="work-log-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Duration</th>
                            <th>Leave Type</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th>Manager Comments</th>
                        </tr>
                    </thead>
                    <tbody id="leaveReportTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Team Management Tab -->
        <div id="team-management" class="tab-content">
            <h2>Employee & Product Mapping</h2>
            
            <div class="alert alert-info">
                <strong>Access Control:</strong> Each employee can only log work for products assigned to them.
            </div>

            <h3>Current Employee-Product Assignments</h3>
            <div id="employeeProductList" style="margin-bottom: 30px;"></div>

            <h3>Add New Employee</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="newEmployeeName">Employee Name</label>
                    <input type="text" id="newEmployeeName" placeholder="Enter employee name">
                </div>
                <div class="form-group">
                    <label>Assigned Products *</label>
                    <div style="margin-bottom: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="selectAllProducts()" style="padding: 6px 12px; font-size: 12px;">Select All</button>
                        <button type="button" class="btn btn-secondary" onclick="deselectAllProducts()" style="padding: 6px 12px; font-size: 12px; margin-left: 5px;">Deselect All</button>
                    </div>
                    <div id="productCheckboxes" style="max-height: 150px; overflow-y: auto; border: 1px solid #e1e5e9; padding: 10px; border-radius: 4px;">
                        <!-- Product checkboxes will be populated here -->
                    </div>
                    <small>Select one or more products for this employee</small>
                </div>
            </div>
            <button class="btn" onclick="addEmployee()">Add Employee</button>

            <h3 style="margin-top: 30px;">Modify Employee Access</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="existingEmployee">Select Employee</label>
                    <select id="existingEmployee" onchange="loadEmployeeProducts()">
                        <option value="">Select Employee</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Update Assigned Products</label>
                    <div style="margin-bottom: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="selectAllModifyProducts()" style="padding: 6px 12px; font-size: 12px;">Select All</button>
                        <button type="button" class="btn btn-secondary" onclick="deselectAllModifyProducts()" style="padding: 6px 12px; font-size: 12px; margin-left: 5px;">Deselect All</button>
                    </div>
                    <div id="modifyProductCheckboxes" style="max-height: 150px; overflow-y: auto; border: 1px solid #e1e5e9; padding: 10px; border-radius: 4px;">
                        <!-- Product checkboxes will be populated here -->
                    </div>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="updateEmployeeProducts()">Update Access</button>

            <h3 style="margin-top: 30px;">Bulk Upload Work Logs</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="bulkUploadFile">Upload CSV/Excel File</label>
                    <input type="file" id="bulkUploadFile" accept=".csv,.xlsx,.xls" style="padding: 8px; border: 1px solid #e1e5e9; border-radius: 4px; width: 100%;">
                    <small>Upload CSV or Excel file with work log entries</small>
                </div>
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="downloadSampleFile()" style="margin-right: 10px;">üì• Download Sample File</button>
                    <button class="btn" onclick="processBulkUpload()">üì§ Upload & Process</button>
                </div>
            </div>
            
            <div id="bulkUploadResults" style="margin-top: 20px;"></div>
        </div>

        <!-- List Management Tab -->
        <div id="list-management" class="tab-content">
            <h2>Manage System Lists</h2>
            <p>Add or remove items from the dropdown lists used in work logging.</p>

            <div class="form-grid">
                <div class="form-group">
                    <label for="listType">Select List to Manage</label>
                    <select id="listType" onchange="loadCurrentList()">
                        <option value="">Select List Type</option>
                        <option value="taskTypes">Task Types</option>
                        <option value="originSources">Origin Sources</option>
                        <option value="operatorRegions">Operator/Regions</option>
                        <option value="products">Products</option>
                        <option value="impactLevels">Impact Levels</option>
                        <option value="taskOwners">Task Owners</option>
                        <option value="statusOptions">Status Options</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newListItem">New Item</label>
                    <input type="text" id="newListItem" placeholder="Enter new item">
                </div>
            </div>
            <button class="btn" onclick="addListItem()">Add Item</button>

            <h3 style="margin-top: 30px;">Current Items</h3>
            <div id="currentListItems" style="max-height: 300px; overflow-y: auto; border: 1px solid #e1e5e9; padding: 15px; border-radius: 8px;">
                <p>Select a list type to view and manage items.</p>
            </div>
        </div>

        <!-- Monthly View Tab -->
        <div id="monthly-view" class="tab-content">
            <h2>Monthly Work Logs</h2>
            
            <div class="week-selector">
                <button class="week-btn active" onclick="selectWeek(1)">Week 1</button>
                <button class="week-btn" onclick="selectWeek(2)">Week 2</button>
                <button class="week-btn" onclick="selectWeek(3)">Week 3</button>
                <button class="week-btn" onclick="selectWeek(4)">Week 4</button>
            </div>

            <div id="monthlyWorkLogs"></div>
        </div>

        <!-- SharePoint Setup Tab -->
        <div id="sharepoint-setup" class="tab-content">
            <div class="setup-guide">
                <h2>üöÄ SharePoint Integration Setup</h2>
                <p style="margin-bottom: 20px;">Follow these steps to connect your work logging system to SharePoint:</p>

                <div class="setup-step">
                    <h4><span class="step-number">1</span>Create SharePoint Site</h4>
                    <p>Go to SharePoint ‚Üí Create Site ‚Üí Team Site</p>
                    <p>Name it something like "Work Logging System"</p>
                    <button class="btn btn-secondary" onclick="window.open('https://sharepoint.com', '_blank')">Open SharePoint</button>
                </div>

                <div class="setup-step">
                    <h4><span class="step-number">2</span>Get Your Site URL</h4>
                    <p>Copy the URL of your new SharePoint site</p>
                    <div class="form-group" style="margin-top: 10px;">
                        <label>Paste your SharePoint Site URL here:</label>
                        <input type="text" id="sharepointSiteUrl" placeholder="https://yourcompany.sharepoint.com/sites/WorkLogging" style="width: 100%;">
                    </div>
                    <button class="btn" onclick="testSharePointConnection()">Test Connection</button>
                </div>

                <div class="setup-step">
                    <h4><span class="step-number">3</span>Automatic List Creation</h4>
                    <p>Once connected, the system will automatically create these SharePoint Lists:</p>
                    <ul style="margin-top: 10px; margin-left: 20px;">
                        <li>WorkLogs - All work entries</li>
                        <li>Employees - Team member information</li>
                        <li>Customers - Customer and product data</li>
                    </ul>
                </div>

                <div class="setup-step">
                    <h4><span class="step-number">4</span>Set Team Permissions</h4>
                    <p>In SharePoint, go to Site Settings ‚Üí Site Permissions</p>
                    <p>Add your team members with "Contribute" permissions</p>
                    <button class="btn btn-secondary" onclick="showPermissionGuide()">Permission Guide</button>
                </div>

                <div id="connectionStatus" class="alert alert-info">
                    <strong>Status:</strong> Not connected to SharePoint. Using local storage.
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="exportSystemConfiguration()">üìã Export System Configuration</button>
                    <button class="btn btn-secondary" onclick="downloadSharePointCompatibleFile()">üì• Download System File</button>
                    <button class="btn" onClick="generateSPFxPackage()">üîß Advanced Options</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // SharePoint configuration for live environment
        const SHAREPOINT_CONFIG = {
            siteUrl: 'https://digitral.sharepoint.com/sites/WorkLoggingSystem',
            listNames: {
                workLogs: 'WorkLogs',
                leaveEntries: 'LeaveEntries', 
                employeeConfig: 'EmployeeConfig',
                systemConfig: 'SystemConfig'
            }
        };
        let workLogs = [];
        let leaveEntries = [];
        let employees = [];
        let customerProducts = {};
        let isSharePointEnabled = false;
        let sharepointSiteUrl = '';
        
        // Your company's specific data lists
        let companyData = {
            taskTypes: [
                'Activity', 'Issue Check', 'Monitoring', 'KT', 'Client Call', 'Internal Call', 
                'CR/CCR Implementation', 'Automation', 'Deployment', 'Daily Task', 
                'Documentation', 'Analysis', 'QA Issue Check', 'IT DESK IM', 
                'Support to Dev & Internal Digital Teams'
            ],
            originSources: [
                'Whatsapp', 'Email', 'External Jira/Ticket', 'Internal Jira', 'Mobile call', 
                'Teams', 'IT HELP DESK', 'Digital TAC', 'Business Ops'
            ],
            operatorRegions: [
                'ORD Myanmar', 'ORD Kuwait', 'ORD Iraq(Asiacell)', 'ORD Indonesia(Indosat)', 
                'ORD Tunisia', 'BSNL India', 'Safaricom Ethiopia', 'Etisalad Afghanistan', 'DTAC'
            ],
            products: [
                'Selfcare', 'Dealer/Retailer/Salesforce', 'Wallet/Mpitesan', 'MiniApp', 
                'Smartsale', 'isales-ftth', 'saleshub', 'B2B App'
            ],
            impactLevels: [
                'Critical-P1', 'Major-P2', 'Minor-P3', 'No Impact-P4'
            ],
            taskOwners: [
                'Nitesh B', 'Vishal V', 'Jithender L', 'Rohit T', 
                'Eswar V', 'Shashank R', 'Sarath D', 'Lakshmi Narasimha B'
            ],
            statusOptions: ['Completed', 'Pending']
        };

        // Employee-Product mapping (each employee can only log for assigned products)
        let employeeProductMapping = {
            'Nitesh B': ['Selfcare', 'MiniApp'],
            'Vishal V': ['Dealer/Retailer/Salesforce', 'Smartsale'],
            'Jithender L': ['Wallet/Mpitesan', 'saleshub'],
            'Rohit T': ['isales-ftth', 'B2B App'],
            'Eswar V': ['Selfcare', 'Dealer/Retailer/Salesforce'],
            'Shashank R': ['MiniApp', 'Smartsale'],
            'Sarath D': ['Wallet/Mpitesan', 'isales-ftth'],
            'Lakshmi Narasimha B': ['saleshub', 'B2B App']
        };

        // Initialize application - Updated for new format
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
            
            // Set default dates for the new format
            document.getElementById('startDate').valueAsDate = new Date();
            document.getElementById('endDate').valueAsDate = new Date();
            
            // Initialize with sample data (no localStorage dependency)
            initializeSampleData();
            updateAllViews();
            
            // Show info about data persistence
            showDataPersistenceInfo();
        });

        function showDataPersistenceInfo() {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'alert alert-info';
            infoDiv.innerHTML = `
                <strong>üìù Data Storage Info:</strong> 
                Data is stored in session memory and will reset when you refresh the page. 
                For permanent storage, set up SharePoint integration using the "SharePoint Setup" tab.
            `;
            document.querySelector('.container').insertBefore(infoDiv, document.querySelector('.nav-tabs'));
            
            // Auto-hide after 8 seconds
            setTimeout(() => infoDiv.remove(), 8000);
        }

        function initializeSampleData() {
            // Initialize employees with your exact team members
            if (employees.length === 0) {
                companyData.taskOwners.forEach((name, index) => {
                    employees.push({
                        id: (index + 1).toString(),
                        name: name,
                        role: 'team_member',
                        email: `${name.toLowerCase().replace(/\s+/g, '.')}@company.com`
                    });
                });
            }

            // Add sample work logs with realistic data if none exist
            if (workLogs.length === 0) {
                const today = new Date();
                const sampleTasks = [
                    'Selfcare portal login issue reported by client',
                    'Daily monitoring of system performance',
                    'Knowledge transfer session for new features',
                    'Dealer portal deployment in Myanmar region',
                    'Critical issue resolution for wallet service',
                    'Internal meeting regarding product enhancement',
                    'Documentation update for API changes',
                    'QA testing for mobile app features'
                ];

                for (let i = 0; i < 20; i++) {
                    const startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - Math.floor(Math.random() * 30));
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + Math.floor(Math.random() * 2)); // Task duration 0-2 days
                    
                    const randomOwner = companyData.taskOwners[Math.floor(Math.random() * companyData.taskOwners.length)];
                    const ownerProducts = employeeProductMapping[randomOwner] || companyData.products.slice(0, 2);
                    const randomProduct = ownerProducts[Math.floor(Math.random() * ownerProducts.length)];
                    
                    workLogs.push({
                        id: Date.now() + i,
                        startDate: startDate.toISOString().split('T')[0],
                        endDate: endDate.toISOString().split('T')[0],
                        taskType: companyData.taskTypes[Math.floor(Math.random() * companyData.taskTypes.length)],
                        timeTaken: Math.floor(Math.random() * 240) + 30,
                        issueTask: sampleTasks[Math.floor(Math.random() * sampleTasks.length)],
                        originOfIssue: companyData.originSources[Math.floor(Math.random() * companyData.originSources.length)],
                        operatorRegion: companyData.operatorRegions[Math.floor(Math.random() * companyData.operatorRegions.length)],
                        product: randomProduct,
                        taskIssueImpact: companyData.impactLevels[Math.floor(Math.random() * companyData.impactLevels.length)],
                        ticketInternalJira: `PROJ-${1000 + Math.floor(Math.random() * 9000)}`,
                        ticketExternalIM: Math.random() > 0.5 ? `INC${100000 + Math.floor(Math.random() * 900000)}` : '',
                        taskIssueOwner: randomOwner,
                        status: companyData.statusOptions[Math.floor(Math.random() * companyData.statusOptions.length)],
                        comments: 'Sample work entry for demonstration purposes'
                    });
                }
            }

            saveToStorage();
            updateDropdowns();
        }

        function updateDropdowns() {
            // Update all dropdowns with company data
            updateDropdownOptions('taskType', companyData.taskTypes);
            updateDropdownOptions('originOfIssue', companyData.originSources);
            updateDropdownOptions('operatorRegion', companyData.operatorRegions);
            updateDropdownOptions('taskIssueImpact', companyData.impactLevels);
            updateDropdownOptions('taskIssueOwner', companyData.taskOwners);
            updateDropdownOptions('status', companyData.statusOptions);
            
            // Update product dropdown (will be filtered based on selected owner)
            updateDropdownOptions('product', companyData.products);
            
            // Update leave employee dropdown
            updateLeaveDropdowns();
            
            // Update employee product assignments dropdowns
            updateEmployeeProductDropdowns();
            
            updateFilterDropdowns();
        }

        function updateLeaveDropdowns() {
            const leaveEmployeeSelect = document.getElementById('leaveEmployee');
            if (leaveEmployeeSelect) {
                leaveEmployeeSelect.innerHTML = '<option value="">Select Employee</option>';
                companyData.taskOwners.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner;
                    option.textContent = owner;
                    leaveEmployeeSelect.appendChild(option);
                });
            }

            // Update leave table
            updateLeaveTable();
        }

        function updateLeaveTable() {
            const tableBody = document.getElementById('leaveTableBody');
            if (tableBody) {
                tableBody.innerHTML = '';
                
                // Show last 10 leave entries
                const recentLeaves = leaveEntries.slice(-10).reverse();
                recentLeaves.forEach(leave => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${leave.employee}</td>
                        <td>${new Date(leave.startDate).toLocaleDateString()}</td>
                        <td>${new Date(leave.endDate).toLocaleDateString()}</td>
                        <td>${leave.duration}</td>
                        <td>${leave.leaveType}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${leave.reason}">${leave.reason}</td>
                        <td><span class="leave-${leave.status.toLowerCase()}">${leave.status}</span></td>
                        <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${leave.comments}">${leave.comments || '-'}</td>
                    `;
                });
            }
        }

        function updateLeaveReports() {
            const tableBody = document.getElementById('leaveReportTableBody');
            tableBody.innerHTML = '';

            let filteredLeaves = [...leaveEntries];
            
            // Apply filters
            const employeeFilter = document.getElementById('filterLeaveEmployee')?.value;
            const typeFilter = document.getElementById('filterLeaveType')?.value;
            const statusFilter = document.getElementById('filterLeaveStatus')?.value;

            if (employeeFilter) filteredLeaves = filteredLeaves.filter(leave => leave.employee === employeeFilter);
            if (typeFilter) filteredLeaves = filteredLeaves.filter(leave => leave.leaveType === typeFilter);
            if (statusFilter) filteredLeaves = filteredLeaves.filter(leave => leave.status === statusFilter);

            // Update leave statistics
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            const monthlyLeaves = leaveEntries.filter(leave => {
                const leaveDate = new Date(leave.startDate);
                return leaveDate.getMonth() === thisMonth && leaveDate.getFullYear() === thisYear;
            });

            // Calculate total leave days (considering half days)
            let totalDays = 0;
            monthlyLeaves.forEach(leave => {
                const start = new Date(leave.startDate);
                const end = new Date(leave.endDate);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                if (leave.duration.includes('Half Day')) {
                    totalDays += days * 0.5;
                } else {
                    totalDays += days;
                }
            });

            document.getElementById('totalLeaveDays').textContent = totalDays;
            document.getElementById('pendingLeaves').textContent = leaveEntries.filter(leave => leave.status === 'Pending').length;
            document.getElementById('approvedLeaves').textContent = leaveEntries.filter(leave => leave.status === 'Approved').length;

            // Populate table
            filteredLeaves.sort((a, b) => new Date(b.startDate) - new Date(a.startDate)).forEach(leave => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${leave.employee}</td>
                    <td>${new Date(leave.startDate).toLocaleDateString()}</td>
                    <td>${new Date(leave.endDate).toLocaleDateString()}</td>
                    <td>${leave.duration}</td>
                    <td>${leave.leaveType}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${leave.reason}">${leave.reason}</td>
                    <td><span class="leave-${leave.status.toLowerCase()}">${leave.status}</span></td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${leave.comments}">${leave.comments || '-'}</td>
                `;
            });
        }

        function applyLeaveFilters() {
            updateLeaveReports();
        }

        function updateDropdownOptions(elementId, options) {
            const select = document.getElementById(elementId);
            if (select) {
                const currentValue = select.value;
                const placeholder = select.querySelector('option[value=""]')?.textContent || 'Select Option';
                
                select.innerHTML = `<option value="">${placeholder}</option>`;
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    select.appendChild(optionElement);
                });
                
                // Restore previous selection if still valid
                if (options.includes(currentValue)) {
                    select.value = currentValue;
                }
            }
        }

        function updateProductsForOwner() {
            const selectedOwner = document.getElementById('taskIssueOwner').value;
            const productSelect = document.getElementById('product');
            
            productSelect.innerHTML = '<option value="">Select Product</option>';
            
            if (selectedOwner && employeeProductMapping[selectedOwner]) {
                // Only show products assigned to this employee
                employeeProductMapping[selectedOwner].forEach(product => {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    productSelect.appendChild(option);
                });
            } else if (selectedOwner) {
                // If no mapping exists, show all products (for backward compatibility)
                companyData.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    productSelect.appendChild(option);
                });
            }
        }

        function updateEmployeeProductDropdowns() {
            // Update checkboxes for adding new employee
            const productCheckboxesDiv = document.getElementById('productCheckboxes');
            const modifyProductCheckboxesDiv = document.getElementById('modifyProductCheckboxes');
            const existingEmployeeSelect = document.getElementById('existingEmployee');
            
            if (productCheckboxesDiv) {
                productCheckboxesDiv.innerHTML = '';
                companyData.products.forEach(product => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.style.cssText = 'margin: 5px 0; display: flex; align-items: center;';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="product_${product.replace(/[^a-zA-Z0-9]/g, '_')}" value="${product}" style="margin-right: 8px;">
                        <label for="product_${product.replace(/[^a-zA-Z0-9]/g, '_')}" style="margin: 0; cursor: pointer;">${product}</label>
                    `;
                    productCheckboxesDiv.appendChild(checkboxDiv);
                });
            }
            
            if (modifyProductCheckboxesDiv) {
                modifyProductCheckboxesDiv.innerHTML = '';
                companyData.products.forEach(product => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.style.cssText = 'margin: 5px 0; display: flex; align-items: center;';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="modify_product_${product.replace(/[^a-zA-Z0-9]/g, '_')}" value="${product}" style="margin-right: 8px;">
                        <label for="modify_product_${product.replace(/[^a-zA-Z0-9]/g, '_')}" style="margin: 0; cursor: pointer;">${product}</label>
                    `;
                    modifyProductCheckboxesDiv.appendChild(checkboxDiv);
                });
            }
            
            if (existingEmployeeSelect) {
                existingEmployeeSelect.innerHTML = '<option value="">Select Employee</option>';
                companyData.taskOwners.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner;
                    option.textContent = owner;
                    existingEmployeeSelect.appendChild(option);
                });
            }
        }

        function updateFilterDropdowns() {
            const filterProduct = document.getElementById('filterProduct');
            if (filterProduct) {
                filterProduct.innerHTML = '<option value="">All Products</option>';
                companyData.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    filterProduct.appendChild(option);
                });
            }
            
            const filterTaskOwner = document.getElementById('filterTaskOwner');
            if (filterTaskOwner) {
                filterTaskOwner.innerHTML = '<option value="">All Owners</option>';
                companyData.taskOwners.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner;
                    option.textContent = owner;
                    filterTaskOwner.appendChild(option);
                });
            }

            // Leave report filters
            const filterLeaveEmployee = document.getElementById('filterLeaveEmployee');
            if (filterLeaveEmployee) {
                filterLeaveEmployee.innerHTML = '<option value="">All Employees</option>';
                companyData.taskOwners.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner;
                    option.textContent = owner;
                    filterLeaveEmployee.appendChild(option);
                });
            }
        }

        function updateProducts() {
            const customer = document.getElementById('customer').value;
            const productSelect = document.getElementById('product');
            
            productSelect.innerHTML = '<option value="">Select Product</option>';
            
            if (customer && customers[customer]) {
                customers[customer].forEach(product => {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    productSelect.appendChild(option);
                });
            }
        }

        // Work log form submission with access control
        document.getElementById('workLogForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedOwner = document.getElementById('taskIssueOwner').value;
            const selectedProduct = document.getElementById('product').value;
            
            // Check if the selected owner is allowed to work on the selected product
            if (selectedOwner && selectedProduct && employeeProductMapping[selectedOwner]) {
                if (!employeeProductMapping[selectedOwner].includes(selectedProduct)) {
                    showAlert(`Access Denied: ${selectedOwner} is not authorized to work on ${selectedProduct}`, 'danger');
                    return;
                }
            }
            
            const formData = {
                id: Date.now(),
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                taskType: document.getElementById('taskType').value,
                timeTaken: parseInt(document.getElementById('timeTaken').value),
                issueTask: document.getElementById('issueTask').value,
                originOfIssue: document.getElementById('originOfIssue').value,
                operatorRegion: document.getElementById('operatorRegion').value,
                product: selectedProduct,
                taskIssueImpact: document.getElementById('taskIssueImpact').value,
                ticketInternalJira: document.getElementById('ticketInternalJira').value,
                ticketExternalIM: document.getElementById('ticketExternalIM').value,
                taskIssueOwner: selectedOwner,
                status: document.getElementById('status').value,
                comments: document.getElementById('comments').value
            };

            workLogs.push(formData);
            saveToStorage();
            
            showAlert('Work entry logged successfully!', 'success');
            document.getElementById('workLogForm').reset();
            
            // Set default dates
            document.getElementById('startDate').valueAsDate = new Date();
            document.getElementById('endDate').valueAsDate = new Date();
            
            updateAllViews();
        });

        // Leave log form submission
        document.getElementById('leaveLogForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const startDate = new Date(document.getElementById('leaveStartDate').value);
            const endDate = new Date(document.getElementById('leaveEndDate').value);
            
            if (endDate < startDate) {
                showAlert('End date cannot be earlier than start date', 'danger');
                return;
            }
            
            const formData = {
                id: Date.now(),
                employee: document.getElementById('leaveEmployee').value,
                startDate: document.getElementById('leaveStartDate').value,
                endDate: document.getElementById('leaveEndDate').value,
                leaveType: document.getElementById('leaveType').value,
                duration: document.getElementById('leaveDuration').value,
                reason: document.getElementById('leaveReason').value,
                status: document.getElementById('leaveStatus').value,
                comments: document.getElementById('leaveComments').value,
                appliedDate: new Date().toISOString().split('T')[0]
            };

            leaveEntries.push(formData);
            saveToStorage();
            
            showAlert('Leave entry logged successfully!', 'success');
            document.getElementById('leaveLogForm').reset();
            
            // Set default dates
            document.getElementById('leaveStartDate').valueAsDate = new Date();
            document.getElementById('leaveEndDate').valueAsDate = new Date();
            
            updateAllViews();
        });

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const logWorkTab = document.getElementById('log-work');
            logWorkTab.insertBefore(alertDiv, logWorkTab.firstChild);
            
            setTimeout(() => alertDiv.remove(), 3000);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'reports') {
                updateReports();
                showReportTab('work-reports'); // Default to work reports
            }
            if (tabName === 'log-leave') updateLeaveDropdowns();
            if (tabName === 'monthly-view') updateMonthlyView();
            if (tabName === 'team-management') updateTeamManagement();
            if (tabName === 'list-management') updateListManagement();
        }

        function showReportTab(reportType) {
            document.querySelectorAll('.report-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('#reports .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(reportType).classList.add('active');
            event.target.classList.add('active');
            
            if (reportType === 'work-reports') {
                updateReports();
            } else if (reportType === 'leave-reports') {
                updateLeaveReports();
            }
        }

        function updateAllViews() {
            updateDashboard();
            updateReports();
            updateMonthlyView();
            updateTeamManagement();
        }

        function updateDashboard() {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            const monthlyLogs = workLogs.filter(log => {
                const logDate = new Date(log.date);
                return logDate.getMonth() === thisMonth && logDate.getFullYear() === thisYear;
            });

            // Update stats
            const totalMinutes = monthlyLogs.reduce((sum, log) => sum + log.timeSpent, 0);
            document.getElementById('totalHours').textContent = Math.round(totalMinutes / 60);
            
            const uniqueCustomers = new Set(monthlyLogs.map(log => log.customer));
            document.getElementById('activeProjects').textContent = uniqueCustomers.size;
            
            document.getElementById('teamMembers').textContent = employees.length;
            document.getElementById('completedTasks').textContent = monthlyLogs.length;

            updateCharts();
        }

        function updateCharts() {
            // Clear existing charts
            ['countryChart', 'weeklyChart', 'taskChart'].forEach(chartId => {
                const canvas = document.getElementById(chartId);
                const existingChart = Chart.getChart(canvas);
                if (existingChart) existingChart.destroy();
            });

            // Country distribution chart
            const countryData = {};
            workLogs.forEach(log => {
                countryData[log.country] = (countryData[log.country] || 0) + log.timeSpent;
            });

            new Chart(document.getElementById('countryChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(countryData),
                    datasets: [{
                        data: Object.values(countryData),
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });

            // Weekly progress chart
            const weeklyData = {};
            workLogs.forEach(log => {
                const week = getWeekNumber(new Date(log.date));
                weeklyData[week] = (weeklyData[week] || 0) + log.timeSpent;
            });

            new Chart(document.getElementById('weeklyChart'), {
                type: 'line',
                data: {
                    labels: Object.keys(weeklyData).sort(),
                    datasets: [{
                        label: 'Minutes Logged',
                        data: Object.values(weeklyData),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });

            // Task distribution chart
            const taskData = {};
            workLogs.forEach(log => {
                taskData[log.task] = (taskData[log.task] || 0) + log.timeSpent;
            });

            new Chart(document.getElementById('taskChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(taskData),
                    datasets: [{
                        label: 'Minutes Spent',
                        data: Object.values(taskData),
                        backgroundColor: '#667eea'
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        function updateReports() {
            const tableBody = document.getElementById('workLogTableBody');
            tableBody.innerHTML = '';

            let filteredLogs = [...workLogs];
            
            // Apply filters
            const productFilter = document.getElementById('filterProduct')?.value;
            const taskOwnerFilter = document.getElementById('filterTaskOwner')?.value;
            const dateRangeFilter = document.getElementById('filterDateRange')?.value;

            if (productFilter) filteredLogs = filteredLogs.filter(log => log.product === productFilter);
            if (taskOwnerFilter) filteredLogs = filteredLogs.filter(log => log.taskIssueOwner === taskOwnerFilter);

            // Apply date range filter
            if (dateRangeFilter) {
                const now = new Date();
                let startDate = new Date();
                
                switch(dateRangeFilter) {
                    case 'this_week':
                        startDate.setDate(now.getDate() - now.getDay());
                        break;
                    case 'last_week':
                        startDate.setDate(now.getDate() - now.getDay() - 7);
                        break;
                    case 'this_month':
                        startDate.setDate(1);
                        break;
                    case 'last_month':
                        startDate.setMonth(now.getMonth() - 1);
                        startDate.setDate(1);
                        break;
                }
                
                filteredLogs = filteredLogs.filter(log => new Date(log.startDate) >= startDate);
            }

            checkMissingLogs();

            // Populate table with new format
            filteredLogs.sort((a, b) => new Date(b.startDate) - new Date(a.startDate)).forEach(log => {
                const row = tableBody.insertRow();
                const impactClass = log.taskIssueImpact.toLowerCase().replace(/[^a-z0-9]/g, '-');
                const statusClass = log.status.toLowerCase().replace(/[^a-z0-9]/g, '-');
                
                row.innerHTML = `
                    <td>${new Date(log.startDate).toLocaleDateString()}</td>
                    <td>${new Date(log.endDate).toLocaleDateString()}</td>
                    <td>${log.taskType}</td>
                    <td>${log.timeTaken}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${log.issueTask}">${log.issueTask}</td>
                    <td>${log.originOfIssue}</td>
                    <td>${log.operatorRegion}</td>
                    <td>${log.product}</td>
                    <td><span class="impact-${impactClass}">${log.taskIssueImpact}</span></td>
                    <td>${log.ticketInternalJira || '-'}</td>
                    <td>${log.ticketExternalIM || '-'}</td>
                    <td>${log.taskIssueOwner}</td>
                    <td><span class="status-${statusClass}">${log.status}</span></td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${log.comments}">${log.comments || '-'}</td>
                `;
            });
        }

        function checkMissingLogs() {
            const alertsContainer = document.getElementById('alertsContainer');
            alertsContainer.innerHTML = '';

            const lastWeek = new Date();
            lastWeek.setDate(lastWeek.getDate() - 7);

            employees.forEach(employee => {
                const hasRecentLog = workLogs.some(log => 
                    log.employee === employee.id && new Date(log.date) >= lastWeek
                );

                if (!hasRecentLog) {
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-warning';
                    alert.textContent = `‚ö†Ô∏è ${employee.name} has not logged any work in the past week`;
                    alertsContainer.appendChild(alert);
                }
            });
        }

        function updateMonthlyView() {
            const container = document.getElementById('monthlyWorkLogs');
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const monthlyLogs = workLogs.filter(log => {
                const logDate = new Date(log.date);
                return logDate.getMonth() === currentMonth && logDate.getFullYear() === currentYear;
            });

            const weeklyData = {};
            monthlyLogs.forEach(log => {
                const week = Math.ceil(new Date(log.date).getDate() / 7);
                if (!weeklyData[week]) weeklyData[week] = [];
                weeklyData[week].push(log);
            });

            let html = '';
            for (let week = 1; week <= 4; week++) {
                const logs = weeklyData[week] || [];
                const totalTime = logs.reduce((sum, log) => sum + log.timeSpent, 0);
                
                html += `
                    <div class="week-summary" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h3>Week ${week}</h3>
                        <p>Total Time: ${Math.round(totalTime / 60)} hours (${totalTime} minutes)</p>
                        <p>Tasks Completed: ${logs.length}</p>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function updateTeamManagement() {
            const employeeProductList = document.getElementById('employeeProductList');
            employeeProductList.innerHTML = '';
            
            Object.keys(employeeProductMapping).forEach(employee => {
                const div = document.createElement('div');
                div.style.cssText = 'background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #667eea;';
                div.innerHTML = `
                    <strong>${employee}</strong>
                    <br><small>Assigned Products: ${employeeProductMapping[employee].join(', ')}</small>
                `;
                employeeProductList.appendChild(div);
            });
        }

        function addEmployee() {
            const name = document.getElementById('newEmployeeName').value.trim();
            
            // Get selected products from checkboxes
            const selectedProducts = [];
            const checkboxes = document.querySelectorAll('#productCheckboxes input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedProducts.push(checkbox.value);
            });
            
            if (name && selectedProducts.length > 0) {
                // Add to task owners list if not already exists
                if (!companyData.taskOwners.includes(name)) {
                    companyData.taskOwners.push(name);
                }
                
                // Set product mapping
                employeeProductMapping[name] = selectedProducts;
                
                // Clear form
                document.getElementById('newEmployeeName').value = '';
                
                // Uncheck all checkboxes
                document.querySelectorAll('#productCheckboxes input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                saveToStorage();
                updateDropdowns();
                updateTeamManagement();
                
                showAlert(`Employee ${name} added with access to: ${selectedProducts.join(', ')}`, 'success');
            } else {
                showAlert('Please enter employee name and select at least one product', 'warning');
            }
        }

        function loadEmployeeProducts() {
            const selectedEmployee = document.getElementById('existingEmployee').value;
            
            // Clear all checkboxes
            document.querySelectorAll('#modifyProductCheckboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            if (selectedEmployee && employeeProductMapping[selectedEmployee]) {
                // Check the products assigned to this employee
                employeeProductMapping[selectedEmployee].forEach(product => {
                    const checkbox = document.querySelector(`#modify_product_${product.replace(/[^a-zA-Z0-9]/g, '_')}`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        function updateEmployeeProducts() {
            const selectedEmployee = document.getElementById('existingEmployee').value;
            
            // Get selected products from checkboxes
            const selectedProducts = [];
            const checkboxes = document.querySelectorAll('#modifyProductCheckboxes input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedProducts.push(checkbox.value);
            });
            
            if (selectedEmployee && selectedProducts.length > 0) {
                employeeProductMapping[selectedEmployee] = selectedProducts;
                saveToStorage();
                updateTeamManagement();
                showAlert(`Updated ${selectedEmployee}'s access to: ${selectedProducts.join(', ')}`, 'success');
            } else {
                showAlert('Please select an employee and at least one product', 'warning');
            }
        }

        function updateListManagement() {
            // This function will be called when the List Management tab is opened
            loadCurrentList();
        }

        function loadCurrentList() {
            const listType = document.getElementById('listType').value;
            const container = document.getElementById('currentListItems');
            
            if (!listType) {
                container.innerHTML = '<p>Select a list type to view and manage items.</p>';
                return;
            }
            
            const items = companyData[listType] || [];
            container.innerHTML = '';
            
            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 4px;';
                itemDiv.innerHTML = `
                    <span>${item}</span>
                    <button class="btn" style="padding: 4px 8px; font-size: 12px; background: #dc3545;" onclick="removeListItem('${listType}', ${index})">Remove</button>
                `;
                container.appendChild(itemDiv);
            });
            
            if (items.length === 0) {
                container.innerHTML = '<p>No items in this list.</p>';
            }
        }

        function addListItem() {
            const listType = document.getElementById('listType').value;
            const newItem = document.getElementById('newListItem').value.trim();
            
            if (!listType || !newItem) {
                showAlert('Please select a list type and enter a new item', 'warning');
                return;
            }
            
            if (companyData[listType].includes(newItem)) {
                showAlert('Item already exists in the list', 'warning');
                return;
            }
            
            companyData[listType].push(newItem);
            document.getElementById('newListItem').value = '';
            
            saveToStorage();
            updateDropdowns();
            loadCurrentList();
            
            showAlert(`Added "${newItem}" to ${listType.replace(/([A-Z])/g, ' $1').toLowerCase()}`, 'success');
        }

        // Select/Deselect all products functions
        function selectAllProducts() {
            document.querySelectorAll('#productCheckboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function deselectAllProducts() {
            document.querySelectorAll('#productCheckboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function selectAllModifyProducts() {
            document.querySelectorAll('#modifyProductCheckboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function deselectAllModifyProducts() {
            document.querySelectorAll('#modifyProductCheckboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Export system configuration
        function exportSystemConfiguration() {
            const systemConfig = {
                exportDate: new Date().toISOString(),
                systemInfo: {
                    name: "Digital Work Logging System",
                    version: "1.0",
                    company: "Digital",
                    totalEmployees: companyData.taskOwners.length,
                    totalProducts: companyData.products.length,
                    totalWorkLogs: workLogs.length,
                    totalLeaveEntries: leaveEntries.length
                },
                columns: {
                    workLogColumns: [
                        "Start Date", "End Date", "Task Type", "Time Taken (Minutes)", 
                        "Issue/Task/Requirement", "Origin of the issue/Task/Requirement", 
                        "Operator/Region", "Product", "Task/Issue Impact", 
                        "Ticket Internal Jira", "Ticket External/IM", "Task/Issue Owner", 
                        "Status", "Comments"
                    ],
                    leaveColumns: [
                        "Employee", "Start Date", "End Date", "Leave Type", "Duration", 
                        "Reason", "Status", "Manager Comments", "Applied Date"
                    ]
                },
                dropdownLists: {
                    taskTypes: companyData.taskTypes,
                    originSources: companyData.originSources,
                    operatorRegions: companyData.operatorRegions,
                    products: companyData.products,
                    impactLevels: companyData.impactLevels,
                    taskOwners: companyData.taskOwners,
                    statusOptions: companyData.statusOptions,
                    leaveTypes: ["Annual Leave", "Sick Leave", "Emergency Leave", "Maternity Leave", "Paternity Leave", "Casual Leave", "Compensatory Off", "Work From Home"],
                    leaveDurations: ["Full Day", "Half Day - Morning", "Half Day - Afternoon"],
                    leaveStatuses: ["Pending", "Approved", "Rejected"]
                },
                employeeProductMappings: employeeProductMapping,
                sampleData: {
                    workLogSample: workLogs.slice(0, 3),
                    leaveSample: leaveEntries.slice(0, 2)
                }
            };

            const blob = new Blob([JSON.stringify(systemConfig, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `system-configuration-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showAlert('‚úÖ System configuration exported successfully!', 'success');
        }

        // Download sample file for bulk upload
        function downloadSampleFile() {
            const sampleData = [
                {
                    "Start Date": "2025-05-30",
                    "End Date": "2025-05-30", 
                    "Task Type": "Activity",
                    "Time Taken (Minutes)": 120,
                    "Issue/Task/Requirement": "Sample task description here",
                    "Origin of the issue/Task/Requirement": "Email",
                    "Operator/Region": "ORD Myanmar",
                    "Product": "Selfcare",
                    "Task/Issue Impact": "Minor-P3",
                    "Ticket Internal Jira": "PROJ-1234",
                    "Ticket External/IM": "INC567890",
                    "Task/Issue Owner": "Nitesh B",
                    "Status": "Completed",
                    "Comments": "Sample comments"
                },
                {
                    "Start Date": "2025-05-31",
                    "End Date": "2025-05-31",
                    "Task Type": "Issue Check", 
                    "Time Taken (Minutes)": 90,
                    "Issue/Task/Requirement": "Another sample task",
                    "Origin of the issue/Task/Requirement": "Teams",
                    "Operator/Region": "BSNL India",
                    "Product": "MiniApp",
                    "Task/Issue Impact": "Major-P2",
                    "Ticket Internal Jira": "PROJ-5678",
                    "Ticket External/IM": "",
                    "Task/Issue Owner": "Vishal V",
                    "Status": "Pending",
                    "Comments": "In progress"
                }
            ];

            // Convert to CSV
            const headers = Object.keys(sampleData[0]);
            let csv = headers.join(',') + '\n';
            sampleData.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    return `"${value}"`;
                });
                csv += values.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'work-log-sample-template.csv';
            link.click();
            URL.revokeObjectURL(url);
            
            showAlert('üì• Sample CSV template downloaded!', 'success');
        }

        // Process bulk upload
        async function processBulkUpload() {
            const fileInput = document.getElementById('bulkUploadFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('Please select a file to upload', 'warning');
                return;
            }

            const resultsDiv = document.getElementById('bulkUploadResults');
            resultsDiv.innerHTML = '<div class="alert alert-info">Processing file...</div>';

            try {
                let data = [];
                
                if (file.name.toLowerCase().endsWith('.csv')) {
                    data = await processCSVFile(file);
                } else if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                    data = await processExcelFile(file);
                } else {
                    throw new Error('Unsupported file format. Please use CSV or Excel files.');
                }

                const validation = validateBulkData(data);
                
                if (validation.isValid) {
                    // Process valid entries
                    validation.validEntries.forEach(entry => {
                        const workLogEntry = {
                            id: Date.now() + Math.random(),
                            startDate: entry['Start Date'],
                            endDate: entry['End Date'],
                            taskType: entry['Task Type'],
                            timeTaken: parseInt(entry['Time Taken (Minutes)']),
                            issueTask: entry['Issue/Task/Requirement'],
                            originOfIssue: entry['Origin of the issue/Task/Requirement'],
                            operatorRegion: entry['Operator/Region'],
                            product: entry['Product'],
                            taskIssueImpact: entry['Task/Issue Impact'],
                            ticketInternalJira: entry['Ticket Internal Jira'] || '',
                            ticketExternalIM: entry['Ticket External/IM'] || '',
                            taskIssueOwner: entry['Task/Issue Owner'],
                            status: entry['Status'],
                            comments: entry['Comments'] || ''
                        };
                        workLogs.push(workLogEntry);
                    });

                    saveToStorage();
                    updateAllViews();
                    
                    resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h4>‚úÖ Bulk Upload Successful!</h4>
                            <p><strong>${validation.validEntries.length}</strong> entries processed successfully.</p>
                            ${validation.errors.length > 0 ? `<p><strong>${validation.errors.length}</strong> entries had errors and were skipped.</p>` : ''}
                        </div>
                        ${validation.errors.length > 0 ? '<div class="alert alert-warning"><h4>‚ö†Ô∏è Errors Found:</h4><ul>' + validation.errors.map(error => `<li>${error}</li>`).join('') + '</ul></div>' : ''}
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h4>‚ùå Format Validation Failed</h4>
                            <p>The uploaded file has format issues:</p>
                            <ul>${validation.errors.map(error => `<li>${error}</li>`).join('')}</ul>
                            <p><strong>Please fix these issues and try again.</strong></p>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>‚ùå Upload Failed</h4>
                        <p>Error: ${error.message}</p>
                        <p>Please check your file format and try again.</p>
                    </div>
                `;
            }
        }

        async function processCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                        const data = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim()) {
                                const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                                const row = {};
                                headers.forEach((header, index) => {
                                    row[header] = values[index] || '';
                                });
                                data.push(row);
                            }
                        }
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read CSV file'));
                reader.readAsText(file);
            });
        }

        async function processExcelFile(file) {
            // For Excel processing, we'd typically use a library like SheetJS
            // For now, show a message asking to convert to CSV
            throw new Error('Excel files not supported in this demo. Please convert to CSV format.');
        }

        function validateBulkData(data) {
            const requiredColumns = [
                'Start Date', 'End Date', 'Task Type', 'Time Taken (Minutes)',
                'Issue/Task/Requirement', 'Origin of the issue/Task/Requirement',
                'Operator/Region', 'Product', 'Task/Issue Impact', 'Task/Issue Owner', 'Status'
            ];
            
            const errors = [];
            const validEntries = [];
            
            // Check if required columns exist
            if (data.length === 0) {
                errors.push('File is empty or invalid format');
                return { isValid: false, errors, validEntries };
            }
            
            const fileColumns = Object.keys(data[0]);
            const missingColumns = requiredColumns.filter(col => !fileColumns.includes(col));
            
            if (missingColumns.length > 0) {
                errors.push(`Missing required columns: ${missingColumns.join(', ')}`);
                return { isValid: false, errors, validEntries };
            }
            
            // Validate each row
            data.forEach((row, index) => {
                const rowNumber = index + 2; // +2 because index starts at 0 and we skip header
                let rowErrors = [];
                
                // Required field validation
                requiredColumns.forEach(col => {
                    if (!row[col] || row[col].toString().trim() === '') {
                        rowErrors.push(`Row ${rowNumber}: Missing ${col}`);
                    }
                });
                
                // Validate dropdown values
                if (row['Task Type'] && !companyData.taskTypes.includes(row['Task Type'])) {
                    rowErrors.push(`Row ${rowNumber}: Invalid Task Type '${row['Task Type']}'`);
                }
                
                if (row['Task/Issue Owner'] && !companyData.taskOwners.includes(row['Task/Issue Owner'])) {
                    rowErrors.push(`Row ${rowNumber}: Invalid Task Owner '${row['Task/Issue Owner']}'`);
                }
                
                if (row['Product'] && !companyData.products.includes(row['Product'])) {
                    rowErrors.push(`Row ${rowNumber}: Invalid Product '${row['Product']}'`);
                }
                
                // Date validation
                if (row['Start Date'] && isNaN(Date.parse(row['Start Date']))) {
                    rowErrors.push(`Row ${rowNumber}: Invalid Start Date format`);
                }
                
                if (row['End Date'] && isNaN(Date.parse(row['End Date']))) {
                    rowErrors.push(`Row ${rowNumber}: Invalid End Date format`);
                }
                
                // Time validation
                if (row['Time Taken (Minutes)'] && (isNaN(row['Time Taken (Minutes)']) || parseInt(row['Time Taken (Minutes)']) <= 0)) {
                    rowErrors.push(`Row ${rowNumber}: Invalid Time Taken value`);
                }
                
                if (rowErrors.length === 0) {
                    validEntries.push(row);
                } else {
                    errors.push(...rowErrors);
                }
            });
            
            return {
                isValid: errors.length === 0 || validEntries.length > 0,
                errors,
                validEntries
            };
        }

        function applyFilters() {
            updateReports();
        }

        function selectWeek(week) {
            document.querySelectorAll('.week-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateMonthlyView();
        }

        function exportData() {
            // Create work logs CSV content matching your exact format
            let workCsv = 'Start Date,End Date,Task Type,Time Taken (Mins),Issue/Task/Requirement,Origin of the issue/Task/Requirement,Operator/Region,Product,Task/Issue Impact,Ticket Internal Jira,Ticket External/IM,Task/Issue Owner,Status,Comments\n';
            
            workLogs.forEach(log => {
                workCsv += `${log.startDate},${log.endDate},${log.taskType},${log.timeTaken},"${log.issueTask}",${log.originOfIssue},${log.operatorRegion},${log.product},${log.taskIssueImpact},${log.ticketInternalJira || ''},${log.ticketExternalIM || ''},${log.taskIssueOwner},${log.status},"${log.comments || ''}"\n`;
            });
            
            // Create leave logs CSV
            let leaveCsv = 'Employee,Start Date,End Date,Leave Type,Duration,Reason,Status,Manager Comments,Applied Date\n';
            
            leaveEntries.forEach(leave => {
                leaveCsv += `${leave.employee},${leave.startDate},${leave.endDate},${leave.leaveType},${leave.duration},"${leave.reason}",${leave.status},"${leave.comments || ''}",${leave.appliedDate}\n`;
            });
            
            // Download work logs
            const workBlob = new Blob([workCsv], { type: 'text/csv' });
            const workUrl = window.URL.createObjectURL(workBlob);
            const workLink = document.createElement('a');
            workLink.href = workUrl;
            workLink.download = `work-logs-${new Date().toISOString().split('T')[0]}.csv`;
            workLink.click();
            window.URL.revokeObjectURL(workUrl);
            
            // Download leave logs
            setTimeout(() => {
                const leaveBlob = new Blob([leaveCsv], { type: 'text/csv' });
                const leaveUrl = window.URL.createObjectURL(leaveBlob);
                const leaveLink = document.createElement('a');
                leaveLink.href = leaveUrl;
                leaveLink.download = `leave-logs-${new Date().toISOString().split('T')[0]}.csv`;
                leaveLink.click();
                window.URL.revokeObjectURL(leaveUrl);
                
                showAlert('Work logs and leave reports exported successfully!', 'success');
            }, 500);
        }

        // Storage functions - Using in-memory storage only
        function saveToStorage() {
            // Data persists in memory during the session
            // For permanent storage, we'll use SharePoint integration
            console.log('Data saved to session memory');
        }

        function loadFromStorage() {
            // In this environment, we'll initialize fresh data each time
            // Real persistence will come through SharePoint
            console.log('Loading fresh session data');
        }

        // Live SharePoint integration functions
        async function connectToLiveSharePoint() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.innerHTML = '<p style="color: blue;">üîÑ Connecting to SharePoint...</p>';
            
            try {
                // Test connection to your live SharePoint site
                const response = await fetch(`${SHAREPOINT_CONFIG.siteUrl}/_api/web`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json;odata=verbose',
                        'Content-Type': 'application/json;odata=verbose'
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    resultDiv.innerHTML = '<p style="color: green;">‚úÖ Successfully connected to SharePoint!</p>';
                    
                    // Now create the required lists
                    await createSharePointLists();
                    
                    isSharePointEnabled = true;
                    sharepointSiteUrl = SHAREPOINT_CONFIG.siteUrl;
                    
                    document.getElementById('sharepointSetupBtn').innerHTML = '‚úÖ SharePoint Connected';
                    document.getElementById('sharepointSetupBtn').className = 'btn btn-success';
                    
                    // Update connection status
                    document.getElementById('connectionStatus').innerHTML = `
                        <strong>Status:</strong> ‚úÖ Connected to https://digitral.sharepoint.com/sites/WorkLoggingSystem
                        <br><small>Lists created successfully. Ready for production use!</small>
                    `;
                    document.getElementById('connectionStatus').className = 'alert alert-success';
                    
                } else if (response.status === 403) {
                    resultDiv.innerHTML = `
                        <p style="color: orange;">‚ö†Ô∏è Permission required</p>
                        <p>Please ensure you have access to the SharePoint site and try again.</p>
                        <button class="btn" onclick="window.open('${SHAREPOINT_CONFIG.siteUrl}', '_blank')">Open SharePoint Site</button>
                    `;
                } else {
                    throw new Error(`Connection failed with status: ${response.status}`);
                }
                
            } catch (error) {
                console.error('SharePoint connection error:', error);
                resultDiv.innerHTML = `
                    <p style="color: red;">‚ùå Connection failed</p>
                    <p>This might be due to browser security restrictions. The system will work in demo mode.</p>
                    <p><strong>Alternative:</strong> Save the system as an HTML file and open it from your local computer for full SharePoint integration.</p>
                    <button class="btn btn-secondary" onclick="downloadSystemFile()">üì• Download System File</button>
                `;
            }
        }

        async function createSharePointLists() {
            const listsToCreate = [
                {
                    name: SHAREPOINT_CONFIG.listNames.workLogs,
                    description: 'Work logging entries with all task details',
                    template: 100,
                    fields: [
                        { name: 'StartDate', type: 'DateTime' },
                        { name: 'EndDate', type: 'DateTime' },
                        { name: 'TaskType', type: 'Text' },
                        { name: 'TimeTaken', type: 'Number' },
                        { name: 'IssueTask', type: 'Note' },
                        { name: 'OriginOfIssue', type: 'Text' },
                        { name: 'OperatorRegion', type: 'Text' },
                        { name: 'Product', type: 'Text' },
                        { name: 'TaskIssueImpact', type: 'Text' },
                        { name: 'TicketInternalJira', type: 'Text' },
                        { name: 'TicketExternalIM', type: 'Text' },
                        { name: 'TaskIssueOwner', type: 'Text' },
                        { name: 'Status', type: 'Text' },
                        { name: 'Comments', type: 'Note' }
                    ]
                },
                {
                    name: SHAREPOINT_CONFIG.listNames.leaveEntries,
                    description: 'Leave requests and approvals',
                    template: 100,
                    fields: [
                        { name: 'Employee', type: 'Text' },
                        { name: 'StartDate', type: 'DateTime' },
                        { name: 'EndDate', type: 'DateTime' },
                        { name: 'LeaveType', type: 'Text' },
                        { name: 'Duration', type: 'Text' },
                        { name: 'Reason', type: 'Note' },
                        { name: 'Status', type: 'Text' },
                        { name: 'ManagerComments', type: 'Note' },
                        { name: 'AppliedDate', type: 'DateTime' }
                    ]
                },
                {
                    name: SHAREPOINT_CONFIG.listNames.employeeConfig,
                    description: 'Employee and product mapping configuration',
                    template: 100,
                    fields: [
                        { name: 'EmployeeName', type: 'Text' },
                        { name: 'AssignedProducts', type: 'Note' },
                        { name: 'Role', type: 'Text' },
                        { name: 'Email', type: 'Text' }
                    ]
                },
                {
                    name: SHAREPOINT_CONFIG.listNames.systemConfig,
                    description: 'System configuration and dropdown lists',
                    template: 100,
                    fields: [
                        { name: 'ConfigType', type: 'Text' },
                        { name: 'ConfigData', type: 'Note' }
                    ]
                }
            ];

            for (const listConfig of listsToCreate) {
                try {
                    await createSharePointListIfNotExists(listConfig);
                } catch (error) {
                    console.warn(`Could not create list ${listConfig.name}:`, error);
                }
            }
        }

        function openSharePointSite() {
            window.open(SHAREPOINT_CONFIG.siteUrl, '_blank');
        }

        function downloadCompleteSystem() {
            try {
                // Get the complete HTML content
                const fullHTML = document.documentElement.outerHTML;
                
                // Create blob and download
                const blob = new Blob([fullHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'digitral-work-logging-system.html';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showAlert('System file downloaded successfully!', 'success');
            } catch (error) {
                console.error('Download failed:', error);
                showCodeCopyDialog();
            }
        }

        function showCodeCopyDialog() {
            const codeDialog = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; justify-content: center; align-items: center;" onclick="this.remove()">
                    <div style="background: white; padding: 20px; border-radius: 15px; max-width: 90%; width: 800px; max-height: 90%; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h2>üìã Copy System Code</h2>
                        <p>Since download isn't working, you can copy the complete code manually:</p>
                        
                        <h3>Method 1: Copy All Code</h3>
                        <button class="btn btn-success" onclick="copySystemCode()" style="margin-bottom: 15px;">üìã Copy Complete HTML Code</button>
                        
                        <h3>Method 2: Manual Steps</h3>
                        <ol style="text-align: left;">
                            <li><strong>Right-click</strong> on this page ‚Üí <strong>"View Page Source"</strong></li>
                            <li><strong>Select All</strong> (Ctrl+A) and <strong>Copy</strong> (Ctrl+C)</li>
                            <li><strong>Create new .html file</strong> on your computer</li>
                            <li><strong>Paste the code</strong> and save as "work-logging-system.html"</li>
                        </ol>
                        
                        <h3>Method 3: SharePoint Direct Upload</h3>
                        <ol style="text-align: left;">
                            <li><strong>Go to your SharePoint site</strong></li>
                            <li><strong>Create new page:</strong> New ‚Üí Page ‚Üí Blank</li>
                            <li><strong>Add Embed web part</strong></li>
                            <li><strong>Paste the HTML code</strong> directly</li>
                        </ol>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn" onclick="this.closest('div[style*=\"position: fixed\"]').remove()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', codeDialog);
        }

        function copySystemCode() {
            const fullHTML = document.documentElement.outerHTML;
            
            // Create temporary textarea to copy content
            const textarea = document.createElement('textarea');
            textarea.value = fullHTML;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showAlert('Complete HTML code copied to clipboard!', 'success');
            } catch (error) {
                console.error('Copy failed:', error);
                // Show the code in a text area for manual copying
                showCodeTextArea(fullHTML);
            }
            
            document.body.removeChild(textarea);
        }

        function showCodeTextArea(htmlCode) {
            const textAreaDialog = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 4000; display: flex; justify-content: center; align-items: center;" onclick="this.remove()">
                    <div style="background: white; padding: 20px; border-radius: 15px; max-width: 95%; width: 1000px; max-height: 95%; overflow: hidden; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
                        <h2>üìã Complete System Code</h2>
                        <p>Select all text below and copy (Ctrl+A, then Ctrl+C):</p>
                        <textarea style="width: 100%; height: 500px; font-family: monospace; font-size: 12px; border: 1px solid #ccc; padding: 10px;" readonly>${htmlCode.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                        <div style="margin-top: 15px; text-align: center;">
                            <button class="btn btn-success" onclick="navigator.clipboard.writeText(this.parentElement.parentElement.querySelector('textarea').value.replace(/&lt;/g, '<').replace(/&gt;/g, '>')).then(() => alert('Copied to clipboard!')).catch(() => alert('Please select all text and copy manually'))">üìã Copy Code</button>
                            <button class="btn" onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="margin-left: 10px;">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', textAreaDialog);
        }

        function generateSPFxPackage() {
            const spfxCode = `
// SharePoint Framework Web Part Package
// File: src/webparts/workLogging/WorkLoggingWebPart.ts

import { Version } from '@microsoft/sp-core-library';
import { BaseClientSideWebPart } from '@microsoft/sp-webpart-base';
import { IPropertyPaneConfiguration, PropertyPaneTextField } from '@microsoft/sp-property-pane';

export interface IWorkLoggingWebPartProps {
  description: string;
}

export default class WorkLoggingWebPart extends BaseClientSideWebPart<IWorkLoggingWebPartProps> {

  public render(): void {
    this.domElement.innerHTML = \`
      ${document.querySelector('.container').outerHTML.replace(/`/g, '\\`')}
      
      <script>
        ${document.querySelector('script').innerHTML.replace(/`/g, '\\`')}
      </script>
      
      <style>
        ${document.querySelector('style').innerHTML.replace(/`/g, '\\`')}
      </style>
    \`;
  }

  protected get dataVersion(): Version {
    return Version.parse('1.0');
  }

  protected getPropertyPaneConfiguration(): IPropertyPaneConfiguration {
    return {
      pages: [
        {
          header: {
            description: 'Work Logging System Settings'
          },
          groups: [
            {
              groupName: 'Basic Settings',
              groupFields: [
                PropertyPaneTextField('description', {
                  label: 'Description'
                })
              ]
            }
          ]
        }
      ]
    };
  }
}
`;

            // Create package.json
            const packageJson = `{
  "name": "digitral-work-logging-system",
  "version": "1.0.0",
  "description": "Digital Work and Leave Logging System for SharePoint",
  "main": "lib/index.js",
  "scripts": {
    "build": "gulp bundle",
    "clean": "gulp clean",
    "test": "gulp test"
  },
  "dependencies": {
    "@microsoft/sp-core-library": "1.18.2",
    "@microsoft/sp-property-pane": "1.18.2",
    "@microsoft/sp-webpart-base": "1.18.2"
  },
  "devDependencies": {
    "@microsoft/sp-build-web": "1.18.2",
    "@microsoft/sp-tslint-rules": "1.18.2",
    "@microsoft/sp-module-interfaces": "1.18.2",
    "@types/webpack-env": "1.13.1",
    "gulp": "4.0.2"
  }
}`;

            showSPFxInstructions(spfxCode, packageJson);
        }

        function showSPFxInstructions(spfxCode, packageJson) {
            const dialog = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; justify-content: center; align-items: center;" onclick="this.remove()">
                    <div style="background: white; padding: 20px; border-radius: 15px; max-width: 95%; width: 1000px; max-height: 95%; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h2>üöÄ SharePoint Framework (SPFx) Package</h2>
                        <p>This creates a professional SharePoint web part:</p>
                        
                        <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h3>üìã Deployment Instructions:</h3>
                            <ol style="text-align: left; margin: 10px 0;">
                                <li><strong>Install Node.js</strong> and SharePoint Framework</li>
                                <li><strong>Create SPFx project:</strong> <code>yo @microsoft/sharepoint</code></li>
                                <li><strong>Replace web part code</strong> with the generated code</li>
                                <li><strong>Build and deploy:</strong> <code>gulp build && gulp bundle --ship && gulp package-solution --ship</code></li>
                                <li><strong>Upload .sppkg</strong> to SharePoint App Catalog</li>
                                <li><strong>Add web part</strong> to any SharePoint page</li>
                            </ol>
                        </div>
                        
                        <h3>Alternative: Simpler Methods</h3>
                        <div style="display: flex; gap: 10px; margin: 15px 0;">
                            <button class="btn btn-success" onclick="showSimpleDeployment()">üìã Simple Deployment Guide</button>
                            <button class="btn btn-secondary" onclick="downloadStandaloneFile()">üì• Download Standalone File</button>
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn" onclick="this.closest('div[style*=\"position: fixed\"]').remove()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialog);
        }

        function showSimpleDeployment() {
            const simpleDialog = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 4000; display: flex; justify-content: center; align-items: center;" onclick="this.remove()">
                    <div style="background: white; padding: 25px; border-radius: 15px; max-width: 90%; width: 800px; max-height: 90%; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h2>‚úÖ Simple SharePoint Deployment</h2>
                        
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h3>üìã Method 1: Document Library (EASIEST)</h3>
                            <ol style="text-align: left;">
                                <li><strong>Download the HTML file</strong> (button below)</li>
                                <li><strong>Go to SharePoint:</strong> <a href="https://digitral.sharepoint.com/sites/WorkLoggingSystem" target="_blank">Your Site</a></li>
                                <li><strong>Click "Documents"</strong> ‚Üí <strong>"Upload"</strong> ‚Üí <strong>"Files"</strong></li>
                                <li><strong>Upload the HTML file</strong></li>
                                <li><strong>Click on the file</strong> to open it in browser</li>
                                <li><strong>Share the link</strong> with your team</li>
                            </ol>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h3>üìã Method 2: SharePoint Page with HTML</h3>
                            <ol style="text-align: left;">
                                <li><strong>Go to SharePoint site</strong></li>
                                <li><strong>New ‚Üí Page ‚Üí Blank</strong></li>
                                <li><strong>Add "Script Editor" web part</strong> (if available)</li>
                                <li><strong>Paste HTML code</strong> directly</li>
                                <li><strong>Save and publish</strong></li>
                            </ol>
                        </div>
                        
                        <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h3>üìã Method 3: External Hosting + Iframe</h3>
                            <ol style="text-align: left;">
                                <li><strong>Host HTML file</strong> on OneDrive or external server</li>
                                <li><strong>Get shareable link</strong></li>
                                <li><strong>Use SharePoint Embed web part</strong> with iframe URL</li>
                            </ol>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-success" onclick="downloadStandaloneFile()" style="margin-right: 10px;">üì• Download HTML File</button>
                            <button class="btn" onclick="this.closest('div[style*=\"position: fixed\"]').remove()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', simpleDialog);
        }

        function downloadSharePointCompatibleFile() {
            try {
                const completeHTML = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digitral Work Logging System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    ${document.querySelector('style').outerHTML}
</head>
<body>
    ${document.querySelector('.container').outerHTML}
    ${document.querySelector('script').outerHTML}
</body>
</html>`;
                
                const blob = new Blob([completeHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'work-logging-system.aspx'; // SharePoint-compatible extension
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showAlert('‚úÖ SharePoint-compatible .aspx file downloaded!', 'success');
            } catch (error) {
                showAlert('‚ùå Download failed. Try the text method instead.', 'danger');
            }
        }

        function showOneDriveConverter() {
            const converterDialog = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: white; padding: 25px; border-radius: 15px; max-width: 90%; width: 700px; max-height: 90%; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h2>üîó OneDrive Link to Embed Converter</h2>
                        
                        <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h3>üìã Step 1: Upload to OneDrive</h3>
                            <ol style="text-align: left; margin: 10px 0;">
                                <li>Go to <strong>OneDrive</strong> (office.com ‚Üí OneDrive)</li>
                                <li>Upload your <strong>work-logging-system.aspx</strong> file</li>
                                <li>Right-click the file ‚Üí <strong>"Share"</strong></li>
                                <li>Set to <strong>"Anyone with the link can view"</strong></li>
                                <li>Copy the sharing link</li>
                            </ol>
                        </div>
                        
                        <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h3>üîÑ Step 2: Convert Link</h3>
                            <div style="margin: 10px 0;">
                                <label><strong>Paste your OneDrive share link here:</strong></label>
                                <input type="text" id="oneDriveLink" placeholder="https://1drv.ms/... or https://onedrive.live.com/..." 
                                       style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <button class="btn btn-success" onclick="convertToEmbed()" style="margin: 10px 0;">üîÑ Convert to Embed URL</button>
                        </div>
                        
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h3>üìã Step 3: Embed URL Result</h3>
                            <div style="margin: 10px 0;">
                                <label><strong>Use this URL in SharePoint Embed web part:</strong></label>
                                <textarea id="embedResult" readonly 
                                         style="width: 100%; height: 80px; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;"
                                         placeholder="Converted embed URL will appear here..."></textarea>
                            </div>
                            <button class="btn btn-secondary" onclick="copyEmbedURL()" style="margin: 5px 0;">üìã Copy Embed URL</button>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h3>‚ö†Ô∏è Important Notes:</h3>
                            <ul style="text-align: left; margin: 10px 0;">
                                <li>Make sure file sharing is set to <strong>"Anyone with link"</strong></li>
                                <li>The embed URL should start with <strong>https://onedrive.live.com/embed</strong></li>
                                <li>Test the embed URL in a new browser tab first</li>
                            </ul>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn" onclick="this.closest('div[style*=\"position: fixed\"]').remove()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', converterDialog);
        }

        function convertToEmbed() {
            const inputLink = document.getElementById('oneDriveLink').value.trim();
            const resultArea = document.getElementById('embedResult');
            
            if (!inputLink) {
                alert('Please paste your OneDrive share link first');
                return;
            }
            
            let embedUrl = '';
            
            try {
                if (inputLink.includes('1drv.ms')) {
                    // Short link - needs to be expanded first
                    embedUrl = 'Please expand this short link first by pasting it in a browser, then use the full URL that appears.';
                } else if (inputLink.includes('onedrive.live.com/redir')) {
                    // Standard OneDrive share link
                    embedUrl = inputLink.replace('/redir?', '/embed?') + '&em=2&wdStartOn=1';
                } else if (inputLink.includes('sharepoint.com') && inputLink.includes('guestaccess.aspx')) {
                    // SharePoint OneDrive link
                    embedUrl = inputLink.replace('guestaccess.aspx', 'embed.aspx') + '&action=embedview';
                } else {
                    embedUrl = 'Unrecognized link format. Please make sure you are using a OneDrive share link.';
                }
                
                resultArea.value = embedUrl;
                
                if (embedUrl.startsWith('https://')) {
                    showAlert('‚úÖ Link converted successfully! Copy the embed URL and use it in SharePoint.', 'success');
                } else {
                    showAlert('‚ö†Ô∏è ' + embedUrl, 'warning');
                }
                
            } catch (error) {
                resultArea.value = 'Error converting link. Please check the format and try again.';
                showAlert('‚ùå Error converting link', 'danger');
            }
        }

        function copyEmbedURL() {
            const resultArea = document.getElementById('embedResult');
            if (resultArea.value && resultArea.value.startsWith('https://')) {
                resultArea.select();
                try {
                    document.execCommand('copy');
                    showAlert('üìã Embed URL copied to clipboard!', 'success');
                } catch (error) {
                    showAlert('Please select the text and copy manually (Ctrl+C)', 'warning');
                }
            } else {
                showAlert('Please convert a link first', 'warning');
            }
        }

        function downloadSetupData() {
            const setupData = {
                currentSession: {
                    employees,
                    customers,
                    workLogs: workLogs.slice(0, 10), // Last 10 work logs
                    totalWorkLogs: workLogs.length,
                    exportDate: new Date().toISOString()
                },
                sharepointConfig: {
                    isEnabled: isSharePointEnabled,
                    siteUrl: sharepointSiteUrl
                },
                instructions: "Import this data into your SharePoint setup or save for backup purposes"
            };
            
            const blob = new Blob([JSON.stringify(setupData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `work-logging-session-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showAlert('Session data downloaded! This includes all your current employees, customers, and work logs.', 'success');
        }

        function showPermissionGuide() {
            alert(`SharePoint Permissions Guide:

1. Go to your SharePoint site
2. Click the gear icon (Settings) ‚Üí Site permissions
3. Click "Invite people"
4. Add team members' email addresses
5. Set permission level to "Contribute"
6. Click "Share"

This allows team members to add/edit work logs but not delete others' entries.`);
        }

        // Utility functions
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }
    </script>
</body>
</html>
